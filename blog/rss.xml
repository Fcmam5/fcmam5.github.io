<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Abdeldjalil Fortas' notepad Blog</title>
        <link>https://fcmam5.me/blog</link>
        <description>Abdeldjalil Fortas' notepad Blog</description>
        <lastBuildDate>Sun, 21 Apr 2024 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[Breaking CORS by "trying to fix¬†it"]]></title>
            <link>https://fcmam5.me/blog/breaking-cors-by-fixing-it</link>
            <guid>https://fcmam5.me/blog/breaking-cors-by-fixing-it</guid>
            <pubDate>Sun, 21 Apr 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[How we can break CORS by trying to "fix it" blindly]]></description>
            <content:encoded><![CDATA[<p>Okay, that's another article about CORS on the internet.</p>
<p>CORS errors are definitely one of the most frustrating errors we face when working on web applications. I don't know what HTTP wizard or how expert you are, but I am sure that you definitely react like Michael Scott here:</p>
<p><img decoding="async" loading="lazy" alt="Michael Scott screaming at CORS issue" src="https://fcmam5.me/assets/images/the-office-m-scott-screaming-at-cors-df2e5ff48704c1ea0cc3935fa8c1f5d9.png" width="1600" height="840" class="img_WapC"></p>
<small><p><em>Meme shamelessly stolen from <a href="https://fatimamo.com/become-a-cors-wizard" target="_blank" rel="noopener noreferrer">this blog</a></em></p></small>
<p>We may break "CORS" or at least break the security barriers it adds by trying to fix it (without understanding it correctly).</p>
<p>According to <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" target="_blank" rel="noopener noreferrer">MDN</a>:</p>
<blockquote>
<p><strong>Cross-Origin Resource Sharing (CORS)</strong> is an <a href="https://developer.mozilla.org/en-US/docs/Glossary/HTTP" target="_blank" rel="noopener noreferrer">HTTP</a>-header based mechanism that allows a server to indicate any <a href="https://developer.mozilla.org/en-US/docs/Glossary/Origin" target="_blank" rel="noopener noreferrer">origins</a> (domain, scheme, or port) other than its own from which a browser should permit loading resources. CORS also relies on a mechanism by which browsers make a "preflight" request to the server hosting the cross-origin resource, in order to check that the server will permit the actual request. In that preflight, the browser sends headers that indicate the HTTP method and headers that will be used in the actual request.</p>
</blockquote>
<p>Now, before you scroll down this article looking for examples where I show you how to carelessly allow all origins to make your new shiny React or Vue application "work", let's ramble for a little bit, and try to make the web a better place.</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="the-problem-with-cors">The problem with CORS<a href="https://fcmam5.me/blog/breaking-cors-by-fixing-it#the-problem-with-cors" class="hash-link" aria-label="Direct link to The problem with CORS" title="Direct link to The problem with CORS">‚Äã</a></h2>
<p>The problem with CORS is <strong>YOU</strong>, <strong>ME</strong>, and the over-simplified tutorials on the internet.</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy" target="_blank" rel="noopener noreferrer">Same-origin</a> is a security barrier that restricts resources from being loaded by one origin.</p>
<p>This policy helps reducing attack vectors by isolating malicious resources.</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" target="_blank" rel="noopener noreferrer">CORS</a> is a way to "<em>lift that barrier</em>" by allowing cross-origin access (<code>C O</code> in <code>CORS</code> as you guessed correctly).</p>
<p>It is a way where your client can load data only from whitelisted origins. For example, if you have a backend API being served from <code>https://api.kavi.wiw</code>, the outcome will be the following:</p>
<table><thead><tr><th>Client</th><th>Server (Target)</th><th>Outcome</th></tr></thead><tbody><tr><td><code>https://api.kavi.wiw/v1</code></td><td><code>https://api.kavi.wiw</code></td><td><code>Same origin</code></td></tr><tr><td><code>http://api.kavi.wiw/</code></td><td><code>https://api.kavi.wiw</code></td><td><code>Different protocol</code></td></tr><tr><td><code>https://api.kavi.wiw:8080/</code></td><td><code>https://api.kavi.wiw</code></td><td><code>Different port</code></td></tr><tr><td><code>https://www.kavi.wiw/</code></td><td><code>https://api.kavi.wiw</code></td><td><code>Different host</code></td></tr></tbody></table>
<p>Two objects have the same origin only when the scheme (protocol), hostname (domain), and port all match.</p>
<p>If my shiny Angular or React front-end application is served from <code>https://www.kavi.wiw/</code> and tries to consume my Node.js APIs on <code>http://api.kavi.wiw/</code>, I mostly likely will get the following error:</p>
<div class="codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-text codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token plain">XMLHttpRequest cannot load http://api.kavi.wiw/.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No 'Access-Control-Allow-Origin' header is present on the requested resource. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Origin 'null' is therefore not allowed access.</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This error is thrown by my browser, as it doesn't let my front-end to load the response from backend.</p>
<p>That's to protect users from calling backends form unauthorized origins. For example, if a threat actor creates clones our front-end, and create a fake website say: <code>https://fake-kavi.wiw</code>. Then sends it to victims.</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy" target="_blank" rel="noopener noreferrer">Same-origin</a> policy blocks this new unauthorized origin from loading responses from <code>http://api.kavi.wiw/</code>.</p>
<p>Anyways, we understood from the error that <code>Access-Control-Allow-Origin</code> is missing. So we can add it to our server responses, but what values should it have?</p>
<p>Tutorials online mostly use wildcards (<code>*</code>), or advice to use packages blindly, I mean even the "GREAT" ChatGPT told me this:</p>
<p><img decoding="async" loading="lazy" alt="ChatGPT advising to use cors package" src="https://fcmam5.me/assets/images/chat-gpt-fix-cors-a7b12d1807b8f24d3a5657509081e9c0.png" width="1274" height="1434" class="img_WapC"></p>
<p>It advised me to use <code>cors</code> package for this example, but if I ask it to not libraries I got the following answer:</p>
<p><img decoding="async" loading="lazy" alt="ChatGPT advising to allow all" src="https://fcmam5.me/assets/images/chat-gpt-fix-cors-no-npm-f07495b4226ac2a65e116d245f1264b9.png" width="1316" height="1328" class="img_WapC"></p>
<p>Both approaches <strong>might be</strong> dangerous, or at least present some bad practices. If you spotted them, feel free to stop reading this article (unless you want to verify your/my information and probably suggest more clarification).</p>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="using-packages-with-default-params">Using packages with default params<a href="https://fcmam5.me/blog/breaking-cors-by-fixing-it#using-packages-with-default-params" class="hash-link" aria-label="Direct link to Using packages with default params" title="Direct link to Using packages with default params">‚Äã</a></h3>
<p>Unless you are a public resource that can be accessed from <strong>ANY origin</strong>, and can be called using <strong>ANY HTTP verb</strong>, using default configuration from packages like <a href="https://www.npmjs.com/package/cors" target="_blank" rel="noopener noreferrer">Node.js's <code>cors</code></a> may present some risks, or at least break the intentions behind having CORS protection.</p>
<p>This implementation:</p>
<div class="language-javascript codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-javascript codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> express </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'express'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> cors </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'cors'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">express</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">use</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">cors</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Is equivalent to having (see <a href="https://www.npmjs.com/package/cors#configuration-options" target="_blank" rel="noopener noreferrer"><code>cors</code> package configuration options</a>):</p>
<div class="language-javascript codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-javascript codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> express </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'express'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> cors </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'cors'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">express</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">use</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">cors</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string-property property" style="color:#36acaa">"origin"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"*"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string-property property" style="color:#36acaa">"methods"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"GET"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string-property property" style="color:#36acaa">"preflightContinue"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string-property property" style="color:#36acaa">"optionsSuccessStatus"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">204</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>These default parameters set a wild card for <code>Access-Control-Allow-Origin</code> header, and authorize all (<code>GET,HEAD,PUT,PATCH,POST,DELETE</code>) headers in <code>Access-Control-Allow-Methods</code>.</p>
<p>You probably just need to authorize certain requests from certain origins. For example, if your public website only serves resources to a static website that only consumes content with <code>GET</code>, you may only need:</p>
<div class="language-javascript codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-javascript codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> express </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'express'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> cors </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'cors'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">express</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">use</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">cors</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string-property property" style="color:#36acaa">"origin"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"https://www.kavi.wiw"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string-property property" style="color:#36acaa">"methods"</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"GET"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="adding-cors-headers-when-not-using-packages">Adding CORS headers (when not using packages)<a href="https://fcmam5.me/blog/breaking-cors-by-fixing-it#adding-cors-headers-when-not-using-packages" class="hash-link" aria-label="Direct link to Adding CORS headers (when not using packages)" title="Direct link to Adding CORS headers (when not using packages)">‚Äã</a></h3>
<p>In the second example, ChatGPT proposed allowing all origins similarly as we may find in many answers on different forums online.</p>
<div class="language-javascript codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-javascript codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">use</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">req</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> res</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> next</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setHeader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Access-Control-Allow-Origin'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'*'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setHeader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Access-Control-Allow-Methods'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'GET, POST, PUT, PATCH, DELETE'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setHeader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Access-Control-Allow-Headers'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Content-Type, Authorization'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The following snippet may present the same challenges with unwanted results as we may get when using packages like <a href="https://www.npmjs.com/package/cors#configuration-options" target="_blank" rel="noopener noreferrer"><code>cors</code></a>.</p>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="using-proxies">Using proxies<a href="https://fcmam5.me/blog/breaking-cors-by-fixing-it#using-proxies" class="hash-link" aria-label="Direct link to Using proxies" title="Direct link to Using proxies">‚Äã</a></h3>
<p>Many tutorials online suggest using proxies (either building our own proxies, or using solutions like <a href="https://github.com/Rob--W/cors-anywhere/" target="_blank" rel="noopener noreferrer">cors-anywhere</a>), this solution when used blindly or without knowing the "Why"s and the "How"s of HTTP/CORS can present security risks, and it may create backdoors by intentionally exposing, or at least facilitating the reach to protected resources.</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="possible-solutions">Possible solutions<a href="https://fcmam5.me/blog/breaking-cors-by-fixing-it#possible-solutions" class="hash-link" aria-label="Direct link to Possible solutions" title="Direct link to Possible solutions">‚Äã</a></h2>
<p>There are no generic solutions. But there are best practices, and these are very project-specific. Don't take advice from random people online. Learn the basics and make your own judgment, or learn to ask the right questions.</p>
<p>Learn more about CORS on:</p>
<ul>
<li>How to prevent CORS-based attacks: <a href="https://portswigger.net/web-security/cors#how-to-prevent-cors-based-attacks" target="_blank" rel="noopener noreferrer">https://portswigger.net/web-security/cors#how-to-prevent-cors-based-attacks</a></li>
<li>Same-origin policy: <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy</a></li>
<li>Cross-Origin Resource Sharing (CORS): <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS</a></li>
<li>CORS Tutorial: A Guide to Cross-Origin Resource Sharing: <a href="https://auth0.com/blog/cors-tutorial-a-guide-to-cross-origin-resource-sharing/" target="_blank" rel="noopener noreferrer">https://auth0.com/blog/cors-tutorial-a-guide-to-cross-origin-resource-sharing/</a></li>
<li>Become a CORS Wizard üßô‚Äç‚ôÄÔ∏è: <a href="https://fatimamo.com/become-a-cors-wizard" target="_blank" rel="noopener noreferrer">https://fatimamo.com/become-a-cors-wizard</a></li>
<li>I want to add CORS support to my server: <a href="https://enable-cors.org/server.html" target="_blank" rel="noopener noreferrer">https://enable-cors.org/server.html</a></li>
<li>Front-end Developer Handbook 2019: <a href="https://frontendmasters.com/guides/front-end-handbook/2019/?#4.4" target="_blank" rel="noopener noreferrer">https://frontendmasters.com/guides/front-end-handbook/2019/?#4.4</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="updates">Updates:<a href="https://fcmam5.me/blog/breaking-cors-by-fixing-it#updates" class="hash-link" aria-label="Direct link to Updates:" title="Direct link to Updates:">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="correction-1">Correction #1<a href="https://fcmam5.me/blog/breaking-cors-by-fixing-it#correction-1" class="hash-link" aria-label="Direct link to Correction #1" title="Direct link to Correction #1">‚Äã</a></h3>
<p><strong>Wrong</strong></p>
<blockquote>
<p><del>CORS, is a security mechanism to protect applications from being called from untrusted origins.</del></p>
</blockquote>
<p><strong>Correction (on <a href="https://www.reddit.com/r/programming/comments/1c9inc9/comment/l0lk2tw/?utm_source=share&amp;utm_medium=web3x&amp;utm_name=web3xcss&amp;utm_term=1&amp;utm_content=share_button" target="_blank" rel="noopener noreferrer">Reddit</a>)</strong></p>
<blockquote>
<p>Same-Origin Policy is the security measure and CORS is a way to lift that protection in selected cases.</p>
</blockquote>]]></content:encoded>
            <category>backend</category>
            <category>frontend</category>
            <category>security</category>
        </item>
        <item>
            <title><![CDATA[Why you should kick idle users out of your website]]></title>
            <link>https://fcmam5.me/blog/why-you-should-kick-idle-users-out-of-your-website</link>
            <guid>https://fcmam5.me/blog/why-you-should-kick-idle-users-out-of-your-website</guid>
            <pubDate>Mon, 25 Dec 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Few tips on how to avoid some of NestJS performance bottlenecks]]></description>
            <content:encoded><![CDATA[<p>If you use any applications that handle sensitive information, you might already have a situation where you get a countdown before you get logged off, this happens if you don‚Äôt interact with the website after a certain (short) period.</p>
<p>Streaming platforms also ask you if you are still watching before they stop the video or navigate to the next episode.</p>
<p>Does this feature harm the user experience? Or does it improve it?
Is it really necessary? This will bring more complexity to implement, test, and maintain.</p>
<p>Or seriously, when this feature is a must-have and how to present it in the least frustrating format to the users.</p>
<p>What if the user wants to disable this feature?</p>
<br>
<p>Of course, the answer to all those questions is: It depends.</p>
<p>Let me enumerate some arguments and situations where force-logging off the users would be needed.</p>
<blockquote>
<p>TLDR; Regulations, to protect user privacy, for security reasons, possibly for your resource management and for keeping meaningful analytics.</p>
</blockquote>
<div class="theme-admonition theme-admonition-note admonition_YnoO alert alert--secondary"><div class="admonitionHeading_YJrT"><span class="admonitionIcon_lSVy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_gK7M"><p>I published this article previously on Medium: <a href="https://medium.com/@Fcmam5/why-you-should-kick-idle-users-out-of-your-website" target="_blank" rel="noopener noreferrer">Why you should kick idle users out of your website</a></p></div></div>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="the-why">The ‚ÄúWHY‚Äù?<a href="https://fcmam5.me/blog/why-you-should-kick-idle-users-out-of-your-website#the-why" class="hash-link" aria-label="Direct link to The ‚ÄúWHY‚Äù?" title="Direct link to The ‚ÄúWHY‚Äù?">‚Äã</a></h2>
<p>If we understand the arguments to do this, we may decide if we should care to implement this or not.</p>
<blockquote>
<p><strong>Spoiler alert:</strong> No you don‚Äôt have to do it always, just use short-lived authentication sessions/tokens.</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="0-privacy">0. Privacy<a href="https://fcmam5.me/blog/why-you-should-kick-idle-users-out-of-your-website#0-privacy" class="hash-link" aria-label="Direct link to 0. Privacy" title="Direct link to 0. Privacy">‚Äã</a></h3>
<p>Users might not follow basic cyber hygiene principles, leaving their devices unlocked and unattended. They may keep their browser tab open to your super-sensitive website. Any unauthorized access to their devices means definite access to their open accounts and active sessions.</p>
<p>If your super-sensitive website implements a feature that checks if the user is idle and logs them out, you might reduce the risk of having unauthorized access or leaking sensitive information from your user‚Äôs account.</p>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="1-security">1. Security<a href="https://fcmam5.me/blog/why-you-should-kick-idle-users-out-of-your-website#1-security" class="hash-link" aria-label="Direct link to 1. Security" title="Direct link to 1. Security">‚Äã</a></h3>
<p>Unauthorized access to one of the users‚Äô accounts may not only cause harm to their data, but it would also be a risk to other users as threat actors will use their victim‚Äôs persona/account in their actions.</p>
<p>That also may put your application at a higher risk as you‚Äôll have to deal with users who already are one step further in your system, and who already have valid authentication tokens and valid external-facing API keys. That would expose them to more features of your application and possibly a larger attack surface.</p>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="2-resource-management">2. Resource management<a href="https://fcmam5.me/blog/why-you-should-kick-idle-users-out-of-your-website#2-resource-management" class="hash-link" aria-label="Direct link to 2. Resource management" title="Direct link to 2. Resource management">‚Äã</a></h3>
<p>You probably saw a prompt on <a href="https://help.netflix.com/en/node/114059" target="_blank" rel="noopener noreferrer">Netflix</a> or <a href="https://support.google.com/youtube/answer/12819304?hl=en" target="_blank" rel="noopener noreferrer">YouTube</a> asking you if you are still watching a video. Or you get a refresh button in your favorite social media platform to refresh content (or login again) after being AFK for a while.</p>
<p>Streaming content is expensive, and it puts a load on both the backend and heavy clients.</p>
<p>No one wants to maintain multiple open connections from their load balancers to users who are not consuming content.</p>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="3-compliance-and-regulations">3. Compliance and regulations<a href="https://fcmam5.me/blog/why-you-should-kick-idle-users-out-of-your-website#3-compliance-and-regulations" class="hash-link" aria-label="Direct link to 3. Compliance and regulations" title="Direct link to 3. Compliance and regulations">‚Äã</a></h3>
<p>It is no surprise, that regulators require logging off inactive users after a moment of inactivity. For example, PSD 2 regulation for example requires logging out the user if they‚Äôre inactive for 5 minutes:</p>
<blockquote>
<p><em>The automatic logout after five minutes of inactivity is a regulatory requirement for banks and payment service providers under the PSD 2 regulation to increase security in online banking. See article 4(3)(d) of the DELEGATED REGULATION (EU) 2018/389 (RTS), <a href="https://eur-lex.europa.eu/legal-content/EN/TXT/PDF/?uri=CELEX:32018R0389&amp;from=EN" target="_blank" rel="noopener noreferrer">https://eur-lex.europa.eu/legal-content/EN/TXT/PDF/?uri=CELEX:32018R0389&amp;from=EN</a> (‚Äúthe maximum time without activity by the payer after being authenticated for accessing its payment account online shall not exceed 5 minutes.‚Äù). [<a href="https://cbportal.commerzbank.com/portal/en/fi/de/system-1/zahlungsdiensterichtlinie_2.html" target="_blank" rel="noopener noreferrer">commerzbank</a>]</em></p>
</blockquote>
<p>This imposes on payment services to implement this feature to be compliant, which is a non-negotiable argument.</p>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="4-getting-better-analytics">4. Getting "better" analytics<a href="https://fcmam5.me/blog/why-you-should-kick-idle-users-out-of-your-website#4-getting-better-analytics" class="hash-link" aria-label="Direct link to 4. Getting &quot;better&quot; analytics" title="Direct link to 4. Getting &quot;better&quot; analytics">‚Äã</a></h3>
<p>User session times, length of videos watched, number of active users, and similar metrics might give valuable information on how clients are consuming your products and/or using your platform.</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="the-how">The ‚ÄúHow‚Äù?<a href="https://fcmam5.me/blog/why-you-should-kick-idle-users-out-of-your-website#the-how" class="hash-link" aria-label="Direct link to The ‚ÄúHow‚Äù?" title="Direct link to The ‚ÄúHow‚Äù?">‚Äã</a></h2>
<p>Throughout the article I used ‚Äúthe feature‚Äù or ‚Äúkick the user if they‚Äôre idle‚Äù or similar expressions.</p>
<p>This feature can be implemented on both the backend and/or front-end. On the backend, you would invalidate idle user sessions (see <a href="https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html#idle-timeout" target="_blank" rel="noopener noreferrer">OWASP recommendation</a>).</p>
<p>The front-end solution would be done by capturing each user‚Äôs activity through events like:</p>
<ul>
<li>Key presses</li>
<li>Mouse move</li>
<li>Clicking</li>
<li>Scrolling</li>
<li>Window resize</li>
</ul>
<p>Then have a timer that we actively reset when the user is active (reset the timer if a new event is triggered).</p>
<p>This part can be easily implemented from scratch (as you already know), or by using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Idle_Detection_API" target="_blank" rel="noopener noreferrer">new <strong>experimental</strong> browser idle APIs</a>, or <a href="https://www.npmjs.com/package/hamid.js" target="_blank" rel="noopener noreferrer">hamid.js</a> library (more on this later).</p>
<p>If a user is idle, there should be presented a prompt component with a timer to remind them to react in case they want to keep their session open.</p>
<p><a href="https://learn.microsoft.com/en-us/business-applications-release-notes/april19/dynamics365-finance-operations/alert-user-before-session-ends" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" alt="Idle prompt from Microsoft Dynamics 365" src="https://fcmam5.me/assets/images/ms-idle-prompt-847eceb6a86a93631a63c4417189c2c3.png" width="554" height="314" class="img_WapC"></a></p>
<p>If they are logged off, it would be beneficial to present them with a flash message to inform them that they were logged off.</p>
<p><img decoding="async" loading="lazy" alt="ELSTER (online German tax office) example" src="https://fcmam5.me/assets/images/elster-1ee6af6a96f1cb880219ce9a2a96e074.png" width="1400" height="412" class="img_WapC"></p>
<p>A similar alert would train the users on the ‚Äúbest practices‚Äù.</p>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="a-word-on-hamidjs">A word on Hamid.js<a href="https://fcmam5.me/blog/why-you-should-kick-idle-users-out-of-your-website#a-word-on-hamidjs" class="hash-link" aria-label="Direct link to A word on Hamid.js" title="Direct link to A word on Hamid.js">‚Äã</a></h3>
<p>A couple of months ago I wrote <a href="https://github.com/Fcmam5/hamid.js" target="_blank" rel="noopener noreferrer">Hamid.js</a>, a lightweight open-source library to trigger actions if a user is inactive.</p>
<p>For example, if you want to logout a user after 5 minutes of being inactive:</p>
<iframe height="300" width="100%" scrolling="no" title="Hamid.js" src="https://codepen.io/Fcmam5/embed/mdodKVN?default-tab=js" frameborder="no" loading="lazy" allowtransparency="true" allowfullscreen="true"><p>See the Pen <a href="https://codepen.io/Fcmam5/pen/mdodKVN">
Hamid.js</a> by Fortas Abdeldjalil (<a href="https://codepen.io/Fcmam5">@Fcmam5</a>)
on <a href="https://codepen.io">CodePen</a>.</p></iframe>
<p>The library listens by default to a <a href="https://github.com/Fcmam5/hamid.js/blob/127b7b5d7f66aa2ffa922695589737ff8b7b0904/src/lib.ts#L35" target="_blank" rel="noopener noreferrer">set of events</a> to determine if the user is active, if none of these events is triggered within the configured time interval (second <code>Hamid</code> constructor parameter, or 5mins by default), the callback we provide as a first parameter will be triggered.</p>
<p>The library will be improved and possibly rewritten to be extensible to support more than web browsers‚Äô events. Of course, all PRs and contributions are welcome!</p>
<blockquote>
<p>The name is inspired from an Algerian meme originated from a comedy show where a bus driver asked his ticketsman to kick someone else from the bus by saying: Hamid, Serhah (release him).</p>
<p><img decoding="async" loading="lazy" alt="Bila Houdoud: Hamid Serhah" src="https://fcmam5.me/assets/images/hamid-ser7ah-fa2c62e378bc1842c4691f94d15609bb.gif" width="640" height="358" class="img_WapC"></p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="final-thoughts">Final thoughts<a href="https://fcmam5.me/blog/why-you-should-kick-idle-users-out-of-your-website#final-thoughts" class="hash-link" aria-label="Direct link to Final thoughts" title="Direct link to Final thoughts">‚Äã</a></h2>
<p>In some cases, we would sacrifice having a ‚Äúseamless‚Äù user-experience and easier implementations to provide the users something that we consider better, or at least, more secure.</p>
<p>This article is based on my experience as a developer, and as a lazy user, I hope it receives feedback from smarter people and hopefully, we enrich it together.</p>]]></content:encoded>
            <category>backend</category>
            <category>frontend</category>
            <category>security</category>
            <category>privacy</category>
            <category>development</category>
        </item>
        <item>
            <title><![CDATA[Avoiding NestJS performance bottlenecks]]></title>
            <link>https://fcmam5.me/blog/avoiding-nestjs-performance-bottlenecks</link>
            <guid>https://fcmam5.me/blog/avoiding-nestjs-performance-bottlenecks</guid>
            <pubDate>Sat, 23 Sep 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Few tips on how to avoid some of NestJS performance bottlenecks]]></description>
            <content:encoded><![CDATA[<p>I have been using <a href="https://nestjs.com/" target="_blank" rel="noopener noreferrer">NestJS</a> for quite some time now. And as every JavaScript developer, I like to complain about it but I still love it, and I still have it as one of my go-to whenever I want to create any Node application.</p>
<p>NestJS helps you enjoy a good developer experience, especially if you are a proponent of OOP, and/or you are working with people who are used to other frameworks like Angular, or coming from a Java/Spring background.</p>
<p>NestJS implements <a href="https://github.com/nestjs/nest/blob/master/packages/common/decorators/core/injectable.decorator.ts" target="_blank" rel="noopener noreferrer">its dependency injection framework</a>, which allows an easy abstraction of dependencies making code easier to maintain, test, and swap third-party libraries.</p>
<p>With its powerful <a href="https://docs.nestjs.com/cli/overview" target="_blank" rel="noopener noreferrer">CLI</a>, NestJS bootstraps applications in record time, it also comes with pre-configured modules, or installable plugins making it pleasant to work with and a powerful beginners-friendly tool.</p>
<div class="theme-admonition theme-admonition-note admonition_YnoO alert alert--secondary"><div class="admonitionHeading_YJrT"><span class="admonitionIcon_lSVy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_gK7M"><p>I published this article previously on Medium: <a href="https://medium.com/@Fcmam5/avoiding-nestjs-performance-bottlenecks-78fa2bc66372" target="_blank" rel="noopener noreferrer">Avoiding NestJS performance bottlenecks</a></p></div></div>
<p>However, ‚Äú<a href="https://youtu.be/377VhCOtoDA" target="_blank" rel="noopener noreferrer">With great power comes great responsibility</a>‚Äù and NestJS is not an exception to Uncle Ben‚Äôs quote.</p>
<p>Nest‚Äôs ‚Äúfancy‚Äù configuration is sometimes more fun to develop, but it sometimes causes performance bottlenecks. Especially when we start customizing things out of the framework‚Äôs way of doing them, then things can get ugly easily.</p>
<p>Here are some of the things I learned over the last few years:</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="carefully-upgrade-to-newer-nestjs-and-nodejs-versions">Carefully upgrade to newer NestJS and Node.js versions<a href="https://fcmam5.me/blog/avoiding-nestjs-performance-bottlenecks#carefully-upgrade-to-newer-nestjs-and-nodejs-versions" class="hash-link" aria-label="Direct link to Carefully upgrade to newer NestJS and Node.js versions" title="Direct link to Carefully upgrade to newer NestJS and Node.js versions">‚Äã</a></h2>
<p>The Node.js community is active and continuously working on improving the ecosystem, and now thanks to <a href="https://github.com/nodejs/performance" target="_blank" rel="noopener noreferrer">a performance-focused team</a> our beloved JavaScript runtime is getting faster and more performant.</p>
<p>One of the performance wins I could achieve was by simply bumping my runtime version from 14 to 16 and then to 18 while making little to no changes to my NestJS microservices code.</p>
<p>Similarly, the NestJS became more stable. With <a href="https://github.com/nestjs/docs.nestjs.com/blob/00a3eaa6ee48d072427805efba7b3d7c19cc74fd/content/migration.md" target="_blank" rel="noopener noreferrer">few</a> breaking changes from v8.x to 10.x, I feel more comfortable keeping up with new major releases to benefit from the new performance improvements, CVE patches, and bug fixes.</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="the-logger">The logger<a href="https://fcmam5.me/blog/avoiding-nestjs-performance-bottlenecks#the-logger" class="hash-link" aria-label="Direct link to The logger" title="Direct link to The logger">‚Äã</a></h2>
<p>NestJS comes with a default <a href="https://github.com/nestjs/nest/blob/67951ff2e9b7f4803856ab8169e23350e49d7dfc/packages/common/services/console-logger.service.ts#L221" target="_blank" rel="noopener noreferrer">logger which is used by default <code>process.stdout.write</code></a>.</p>
<p><code>process.stdout</code> and <code>process.stderr</code> is not advised to be used in logging as it may behave synchronously and block the event loop, as the <a href="https://nodejs.org/api/process.html#a-note-on-process-io" target="_blank" rel="noopener noreferrer">Node.js documentation states</a>:</p>
<blockquote>
<p><strong>Warning:</strong> <em>Synchronous writes block the event loop until the write has completed. This can be near instantaneous in the case of output to a file, but under high system load, pipes that are not being read at the receiving end, or with slow terminals or file systems, it‚Äôs possible for the event loop to be blocked often enough and long enough to have severe negative performance impacts. This may not be a problem when writing to an interactive terminal session, <strong>but consider this particularly careful when doing production logging to the process output streams</strong>.</em></p>
</blockquote>
<p>Gladly, the logger <a href="https://docs.nestjs.com/techniques/logger#use-external-logger" target="_blank" rel="noopener noreferrer">can be easily customized</a> and replaced by dedicated logging libraries such as <a href="https://github.com/iamolegga/nestjs-pino" target="_blank" rel="noopener noreferrer">nestjs-pino</a> and <a href="https://github.com/gremo/nest-winston" target="_blank" rel="noopener noreferrer">nest-winston</a> which also offer more flexibility and better performance. NestJS documentation covers that well.</p>
<p>However, even when using custom loggers there are some things to consider.</p>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="startup-logger">Startup logger<a href="https://fcmam5.me/blog/avoiding-nestjs-performance-bottlenecks#startup-logger" class="hash-link" aria-label="Direct link to Startup logger" title="Direct link to Startup logger">‚Äã</a></h3>
<p>Even if you use a custom logging library, you‚Äôd still have the first few logs printed in Nest‚Äôs standard standard form. As NestJS will start streaming application start logs before the logger is attached, that not only may lose crucial framework setup logs from being hidden from logging dashboards but also impact the startup time with few MS.</p>
<p>For example, I usually go for <a href="https://github.com/pinojs/pino" target="_blank" rel="noopener noreferrer">Pino</a> (with <a href="https://github.com/iamolegga/nestjs-pino" target="_blank" rel="noopener noreferrer">nestjs-pino</a>) as my logging library, my <code>main.ts</code> have:</p>
<div class="language-typescript codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-typescript codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> NestFactory </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'@nestjs/core'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> AppModule </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'./app.module'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Logger </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'nestjs-pino'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bootstrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> NestFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AppModule</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">useLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Logger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">listen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">bootstrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This produces a mixed log format as the following:</p>
<div class="language-json codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-json codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Nest</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">89914</span><span class="token plain">  - </span><span class="token number" style="color:#36acaa">09</span><span class="token plain">/</span><span class="token number" style="color:#36acaa">16</span><span class="token plain">/</span><span class="token number" style="color:#36acaa">2023</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">25</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">41</span><span class="token plain"> AM     LOG </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NestFactory</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Starting Nest application...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Nest</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">89914</span><span class="token plain">  - </span><span class="token number" style="color:#36acaa">09</span><span class="token plain">/</span><span class="token number" style="color:#36acaa">16</span><span class="token plain">/</span><span class="token number" style="color:#36acaa">2023</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">25</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">41</span><span class="token plain"> AM     LOG </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">InstanceLoader</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> AppModule dependencies initialized +16ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Nest</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">89914</span><span class="token plain">  - </span><span class="token number" style="color:#36acaa">09</span><span class="token plain">/</span><span class="token number" style="color:#36acaa">16</span><span class="token plain">/</span><span class="token number" style="color:#36acaa">2023</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">25</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">41</span><span class="token plain"> AM     LOG </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">InstanceLoader</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> LoggerModule dependencies initialized +0ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"level"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"time"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1694823941975</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"pid"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">89914</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"hostname"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Fcmam5"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"context"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"RoutesResolver"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"msg"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"AppController {/}:"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"level"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"time"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1694823941978</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"pid"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">89914</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"hostname"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Fcmam5"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"context"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"RouterExplorer"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"msg"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Mapped {/, GET} route"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"level"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"time"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1694823941980</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"pid"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">89914</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"hostname"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Fcmam5"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"context"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"NestApplication"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"msg"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Nest application successfully started"</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The fix would be just buffering logs by setting <code>bufferLogs</code> to <code>true</code>:</p>
<div class="language-typescript codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-typescript codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> NestFactory </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'@nestjs/core'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> AppModule </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'./app.module'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Logger </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'nestjs-pino'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bootstrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> NestFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AppModule</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> bufferLogs</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">useLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Logger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">listen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">bootstrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This makes sure all logs will be buffered until the custom logger is attached and then logged in its format (<code>nestjs-pino</code> in this case), so I would have something like:</p>
<div class="language-json codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-json codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"level"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"time"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1694858121769</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"pid"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">97585</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"hostname"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Fcmam5"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"context"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"NestFactory"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"msg"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Starting Nest application..."</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"level"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"time"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1694858121770</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"pid"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">97585</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"hostname"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Fcmam5"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"context"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"InstanceLoader"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"msg"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"AppModule dependencies initialized"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"level"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"time"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1694858121770</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"pid"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">97585</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"hostname"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Fcmam5"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"context"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"InstanceLoader"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"msg"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"LoggerModule dependencies initialized"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"level"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"time"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1694858121770</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"pid"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">97585</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"hostname"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Fcmam5"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"context"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"RoutesResolver"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"msg"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"AppController {/}:"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"level"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"time"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1694858121770</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"pid"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">97585</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"hostname"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Fcmam5"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"context"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"RouterExplorer"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"msg"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Mapped {/, GET} route"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">"level"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"time"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1694858121770</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"pid"</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">97585</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"hostname"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Fcmam5"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"context"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"NestApplication"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">"msg"</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Nest application successfully started"</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note that for standalone applications <a href="https://github.com/iamolegga/nestjs-pino#logger-substitution" target="_blank" rel="noopener noreferrer">you may need to flush log buffers manually</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="injection-scopes">Injection scopes<a href="https://fcmam5.me/blog/avoiding-nestjs-performance-bottlenecks#injection-scopes" class="hash-link" aria-label="Direct link to Injection scopes" title="Direct link to Injection scopes">‚Äã</a></h2>
<p>We had a use case where we wanted to inject a <a href="https://microsoft.github.io/code-with-engineering-playbook/observability/correlation-id/" target="_blank" rel="noopener noreferrer">correlation ID</a> into our logs to keep track of what was happening in our application for a particular request.</p>
<p>The na√Øve approach I was about to use, was to implement a <a href="https://docs.nestjs.com/fundamentals/injection-scopes#request-provider" target="_blank" rel="noopener noreferrer">request-scoped</a> instance of the logger, something like:</p>
<div class="language-typescript codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-typescript codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Injectable</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Scope</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Inject</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'@nestjs/common'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">Injectable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> scope</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Scope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">REQUEST</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">SomeBrokenLoggingService</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">callCustomLoggingLib</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">reqId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCorrelationID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then I learned how bad that call was, I overlooked the fact that this approach means that I will be instantiating a new instance <code>SomeBrokenLoggingService</code> for each request, that would impact my application performance (see: <a href="https://docs.nestjs.com/fundamentals/injection-scopes#performance" target="_blank" rel="noopener noreferrer">injection-scopes#performance</a>).</p>
<p>The learnings I got from that were:</p>
<ol>
<li>To use a well-maintained library to do that for me.</li>
<li>To be more careful with Injection scopes.</li>
<li>Consider using <a href="https://docs.nestjs.com/recipes/async-local-storage" target="_blank" rel="noopener noreferrer">async local storage</a> for some use cases (recently added, thanks NestJS community!).</li>
</ol>
<p>For example, <a href="https://github.com/iamolegga/nestjs-pino#faq" target="_blank" rel="noopener noreferrer">nestjs-pino</a> uses <a href="https://nodejs.org/api/async_context.html#async_context_class_asynclocalstorage" target="_blank" rel="noopener noreferrer">AsyncLocalStorage</a> (previously relied on <a href="https://www.npmjs.com/package/cls-hooked" target="_blank" rel="noopener noreferrer">cls-hooked</a> package).</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="use-fastify">Use Fastify<a href="https://fcmam5.me/blog/avoiding-nestjs-performance-bottlenecks#use-fastify" class="hash-link" aria-label="Direct link to Use Fastify" title="Direct link to Use Fastify">‚Äã</a></h2>
<p>Made by Node.js maintainers who worked on performance, Fastify <a href="https://fastify.dev/benchmarks" target="_blank" rel="noopener noreferrer">has proven its performance</a> and it‚Äôs making its way to compete with Express to be the most popular Node.js framework.</p>
<p>NestJS comes by default with <a href="https://www.npmjs.com/package/@nestjs/platform-express" target="_blank" rel="noopener noreferrer">Express platform</a>, but it can be easily switched to Fastify, and the documentation did a great job explaining it on the <a href="https://docs.nestjs.com/techniques/performance#performance-fastify" target="_blank" rel="noopener noreferrer">‚ÄúPerformance (Fastify)‚Äù page</a>.</p>
<p>The switch from Express to Fastify can be done easily if your codebase is not relying on Express-specific code (as it should be if done √† la NestJS), you may only change req/res types from Fastify‚Äôs Request and FastifyReply interfaces and probably have to replace the usage of some packages like helmet <a href="https://docs.nestjs.com/security/helmet#use-with-fastify" target="_blank" rel="noopener noreferrer">to use helmet/fastify</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="other-things-to-consider">Other things to consider<a href="https://fcmam5.me/blog/avoiding-nestjs-performance-bottlenecks#other-things-to-consider" class="hash-link" aria-label="Direct link to Other things to consider" title="Direct link to Other things to consider">‚Äã</a></h2>
<p>Rule #0: <strong>MEASURE!</strong></p>
<p>Before blaming the framework, we should make sure that our code is performant, that our usage of third-party components is efficient, and that our database queries are efficient.</p>
<p>Then we may start looking into other framework-related micro-optimizations:</p>
<ul>
<li>Global pipes, middlewares, guards, and filters might not be always a good idea.
They sometimes run unnecessary code for endpoints that don‚Äôt need their transformations.</li>
<li>Use lazy loading if it‚Äôs relevant to your use case.
Lazy loading defers module registration by loading them asynchronously to decrease application startup time (which might make sense in a serverless environment).</li>
<li>If you are using the config module, and accessing environment variables using <code>process.env</code> might be slow, cashing can be a solution, see: <a href="https://docs.nestjs.com/techniques/configuration#cache-environment-variables" target="_blank" rel="noopener noreferrer">Cache environment variables</a>.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="final-thoughts">Final thoughts<a href="https://fcmam5.me/blog/avoiding-nestjs-performance-bottlenecks#final-thoughts" class="hash-link" aria-label="Direct link to Final thoughts" title="Direct link to Final thoughts">‚Äã</a></h2>
<p>It might be unfair to compare NestJS to Express, Hapi, Koa, or Fastify. We will find out that it‚Äôs either slow, has a bigger memory footprint, or uses more CPU. That makes sense.</p>
<p>NestJS takes care of a lot of things by default to offer a good and <em>‚Äúflexible‚Äù</em> developer experience with its built-in libraries and configurations making <a href="https://stackoverflow.com/a/48226084/5078746" target="_blank" rel="noopener noreferrer">micro-sacrifices of performance</a>, which can be accepted.</p>
<p><a href="https://youtu.be/tKbV6BpH-C8" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" alt="CodeAesthetic: Premature optimization" src="https://fcmam5.me/assets/images/premature-optimization-dbb1c414c2c337dae45a02b1b6d4463c.png" width="1400" height="802" class="img_WapC"></a></p>
<p>Premature optimization is evil, and if one really can spot performance decrease; Analysis must be done first, by applying the <a href="https://en.wikipedia.org/wiki/Pareto_principle" target="_blank" rel="noopener noreferrer">20-80% rule</a>, we may figure out that most performance hits are not directly related to the framework, but our code, our logic and the way we interact with third-parties.</p>
<p>We should first find the bottlenecks that are decreasing performance the most, fix them, monitor and then consider if it makes sense to push for more micro-optimizations.</p>]]></content:encoded>
            <category>backend</category>
            <category>nestjs</category>
            <category>development</category>
        </item>
        <item>
            <title><![CDATA[CTF as a developer (Pt. 1): Template engines & SSTI]]></title>
            <link>https://fcmam5.me/blog/ctf-as-a-developer-pt-1-template-engines-ssti</link>
            <guid>https://fcmam5.me/blog/ctf-as-a-developer-pt-1-template-engines-ssti</guid>
            <pubDate>Thu, 07 Sep 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Learning about cybersecurity as a developer by playing CTF (Part1: Template engines and SSTI)]]></description>
            <content:encoded><![CDATA[<p>Being a software developer is a responsibility, it‚Äôs a job where we provide secure and stable services and infrastructure to users who trust us (or trust regulations that ensure we are trustworthy).</p>
<p>To learn more about cybersecurity principles, and why some ‚Äúbest practices‚Äù matter, I decided to play some CTF challenges instead of only relying on reading articles and scrolling into OWASP top 10‚Äôs documentation.</p>
<p>My beginning was with HackTheBox. For some reason, some of the challenges I did had <a href="https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/18-Testing_for_Server-side_Template_Injection" target="_blank" rel="noopener noreferrer">Server-side Template Injection (SSTI)</a> vulnerabilities which I‚Äôm starting this blog series with.</p>
<blockquote>
<p>If you are a security professional or an experienced programmer this article might not bring you anything new, feel free to stop reading now, but I would appreciate your inputs, corrections and guidance!</p>
</blockquote>
<div class="theme-admonition theme-admonition-note admonition_YnoO alert alert--secondary"><div class="admonitionHeading_YJrT"><span class="admonitionIcon_lSVy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_gK7M"><p>I published this article previously on Medium: <a href="https://medium.com/@Fcmam5/ctf-as-a-developer-pt-1-template-engines-ssti-b03c59e2c095" target="_blank" rel="noopener noreferrer">CTF as a developer (Pt. 1): Template engines &amp; SSTI</a></p></div></div>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="what-are-template-engines">What are template engines?<a href="https://fcmam5.me/blog/ctf-as-a-developer-pt-1-template-engines-ssti#what-are-template-engines" class="hash-link" aria-label="Direct link to What are template engines?" title="Direct link to What are template engines?">‚Äã</a></h2>
<p>Template engines are tools that facilitate rendering content for web applications by injecting data into static templates.</p>
<p>Template engines like <a href="https://github.com/pallets/jinja" target="_blank" rel="noopener noreferrer">Jinja</a>, <a href="https://handlebarsjs.com/" target="_blank" rel="noopener noreferrer">Handlebars</a>, <a href="https://ejs.co/" target="_blank" rel="noopener noreferrer">EJS</a>, or PHP‚Äôs <a href="https://twig.symfony.com/" target="_blank" rel="noopener noreferrer">Twig</a> provide more features for developers to add more logic (with variables, functions, loops, etc.) to templates which makes development and maintenance easier.</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="server-side-template-injection-ssti-vulnerabilities">Server-side template injection (SSTI) vulnerabilities<a href="https://fcmam5.me/blog/ctf-as-a-developer-pt-1-template-engines-ssti#server-side-template-injection-ssti-vulnerabilities" class="hash-link" aria-label="Direct link to Server-side template injection (SSTI) vulnerabilities" title="Direct link to Server-side template injection (SSTI) vulnerabilities">‚Äã</a></h2>
<p>Consider this simple, and ugly app that greets the user every time they visit our <code>/greeting/&lt;name&gt;</code> route:</p>
<div class="language-python codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-python codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> flask </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Flask</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> render_template_string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> random </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> choice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Flask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__name__</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/greeting/&lt;name&gt;"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">greeting</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    greeting </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> choice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"Hi"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Hello"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Welcome"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    template </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:#e3116c">'''</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;html lang="en"&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &lt;meta charset="UTF-8" /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &lt;title&gt;Greeting&lt;/title&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;/head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &lt;h1&gt;'''</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> greeting </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">' '</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:#e3116c">'''!&lt;/h1&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;/body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;/html&gt;'''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> render_template_string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">template</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'__main__'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">debug</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8080</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For example, <code>GET /greeting/Alice</code> would show:</p>
<p><img decoding="async" loading="lazy" alt="Example page" src="https://fcmam5.me/assets/images/tpl-1-9c68e0c2241aaf03e3a954ab3f91d453.png" width="720" height="260" class="img_WapC"></p>
<p>Now that we (or attackers) know that we are passing a user-provided variable to the template, we can experiment by passing a Jinja2 expression <code>{{ 2 + 2 }}</code>. In my case that would show:</p>
<p><img decoding="async" loading="lazy" alt="Template injection example" src="https://fcmam5.me/assets/images/tpl-2-0d98ae8f0248cec44074fab07fb3b902.png" width="720" height="183" class="img_WapC"></p>
<p>This means that the expression was evaluated as a Jinja template, which means that attackers can inject Python code that can do anything, for example running an <code>ls -R</code> on the application server‚Äôs shell with an expression like the following:</p>
<div class="language-python codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-python codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">application</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__globals__</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__builtins__</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">__import__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'os'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">popen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'ls -R'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Which will show:</p>
<p><img decoding="async" loading="lazy" alt="ls -R" src="https://fcmam5.me/assets/images/ls-r-injection-d7641ae71a43a620f8321fdc4e8d0ed0.png" width="1264" height="326" class="img_WapC"></p>
<p>Attackers can be creative from here, they can run any command to upload/download more malicious scripts to our application servers which will give them more access and make things far easier for them.</p>
<p>The risks of such an attack are high, especially since even skiddies may use free scripts and tools that are available online to scan and exploit websites. The magical command:</p>
<div class="language-python codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-python codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">application</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__globals__</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__builtins__</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">__import__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'os'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">popen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'ls -R'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Can be found in serval blogs online along with other tricks for more powerful exploits. That means that anyone can exploit it, so please let‚Äôs take it seriously.</p>
<p>Security professionals and threat actors also rely on tools (such as <a href="https://github.com/epinna/tplmap" target="_blank" rel="noopener noreferrer">tplmap</a>) to find and exploit real-world applications, which makes SSTI vulnerabilities critical to solve as they might be easy to find and exploit.</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="why-should-i-even-care">Why should I even care?<a href="https://fcmam5.me/blog/ctf-as-a-developer-pt-1-template-engines-ssti#why-should-i-even-care" class="hash-link" aria-label="Direct link to Why should I even care?" title="Direct link to Why should I even care?">‚Äã</a></h2>
<p>Even if you are building a small side-project, you really have to not neglect basic security aspects.</p>
<p>Threat actors may use your applications‚Äô servers as nodes in their botnets, or use them as proxies when performing attacks on more critical targets.
Or they would make your application server into a crypto-miner, or a platform to run their CPU-expensive applications.</p>
<p>You really don‚Äôt want to have unnecessary cost and legal implications for just neglecting good practices.</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="remediation">Remediation<a href="https://fcmam5.me/blog/ctf-as-a-developer-pt-1-template-engines-ssti#remediation" class="hash-link" aria-label="Direct link to Remediation" title="Direct link to Remediation">‚Äã</a></h2>
<p>There are plenty of articles online by security professionals who‚Äôd tell you how to protect yourself from SSTI and this one would only give typical recommendations:</p>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="never-trust-client-side-validation">NEVER trust client-side validation<a href="https://fcmam5.me/blog/ctf-as-a-developer-pt-1-template-engines-ssti#never-trust-client-side-validation" class="hash-link" aria-label="Direct link to NEVER trust client-side validation" title="Direct link to NEVER trust client-side validation">‚Äã</a></h3>
<p>Client-side validation is for real application users, it offers guidance and early feedback if they insert any invalid input. It can never block any attack as it can easily bypassed with different techniques.</p>
<p><img decoding="async" loading="lazy" alt="Programmerhummor: Client-side validation" src="https://fcmam5.me/assets/images/client-side-validation-a9874f37922099edca00ca12cf2adefe.png" width="480" height="270" class="img_WapC"></p>
<p>As trivial as it sounds to any experienced developer or any security professional reading this, we still can find unprotected endpoints.</p>
<p>The absence of server-side validation might happen if applications are built by inexperienced and junior developers (WRITING about it, since I‚Äôm guilty of this), or it may also happen correctly if front-end and backend developers are not aligned which would produce inconsistencies in validation rules.</p>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="use-well-maintained-and-known-template-engines">Use well-maintained and known template engines<a href="https://fcmam5.me/blog/ctf-as-a-developer-pt-1-template-engines-ssti#use-well-maintained-and-known-template-engines" class="hash-link" aria-label="Direct link to Use well-maintained and known template engines" title="Direct link to Use well-maintained and known template engines">‚Äã</a></h3>
<p>Sometimes <a href="https://en.wikipedia.org/wiki/Linus%27s_law" target="_blank" rel="noopener noreferrer">Linus‚Äôs law</a> applies; given enough eyeballs looking at a particular code, bugs and security issues will be discovered.</p>
<p>Template engines like Jinja, EJS, or Twig are maintained by many smart developers who try to maintain them while keeping them safe.</p>
<p>If you are working on an application that would go to production, consider using stable and well-maintained libraries and keeping them up-to-date as they will always provide patches to any possible CVEs.</p>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="read-the-documentation">Read the documentation<a href="https://fcmam5.me/blog/ctf-as-a-developer-pt-1-template-engines-ssti#read-the-documentation" class="hash-link" aria-label="Direct link to Read the documentation" title="Direct link to Read the documentation">‚Äã</a></h3>
<p>Good libraries are well-documented by the people who built them, and who are using them. You should always rely on the official documentation and not only blog articles and copying around code snippets from StackOverflow or some AI-generated tools.</p>
<p>Sometimes, defaults are evil, and sometimes they are ‚Äúthe safest‚Äù option. Only a wise developer can understand how things work and how they should be used.</p>
<p>For example, my previous demo wouldn‚Äôt work if I just used <a href="https://flask.palletsprojects.com/en/2.3.x/api/#flask.render_template_string" target="_blank" rel="noopener noreferrer">flask.render_template_string</a> correctly by passing my variables as parameters and letting it synthesize the rendered expression</p>
<div class="language-python codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-python codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">greeting</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    greeting </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> choice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"Hi"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Hello"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Welcome"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    template </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:#e3116c">'''</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;html lang="en"&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &lt;meta charset="UTF-8" /&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &lt;title&gt;Greeting&lt;/title&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;/head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &lt;h1&gt; {{ greeting }} {{ name }}!&lt;/h1&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;/body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;/html&gt;'''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> render_template_string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">template</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> greeting</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">greeting</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then the passed value will be synthesized, and rendered as a string</p>
<p><img decoding="async" loading="lazy" alt="Sanitized output" src="https://fcmam5.me/assets/images/sanized-output-9a7d0b45430fd205210b3ef5c59baa7a.png" width="1314" height="294" class="img_WapC"></p>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="sanitizing-inputs">Sanitizing inputs<a href="https://fcmam5.me/blog/ctf-as-a-developer-pt-1-template-engines-ssti#sanitizing-inputs" class="hash-link" aria-label="Direct link to Sanitizing inputs" title="Direct link to Sanitizing inputs">‚Äã</a></h3>
<p>Not trusting any user-provided input by validating and sanitizing is a general rule when building applications.</p>
<p>One other piece of advice is to use libraries, and not overengineer another sanitization and/or validation library unless you have a very specific use case and enough resources to build it. It is hard to list and cover all possible scenarios and tricks by yourself.</p>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="dont-guide-attackers">Don‚Äôt guide attackers<a href="https://fcmam5.me/blog/ctf-as-a-developer-pt-1-template-engines-ssti#dont-guide-attackers" class="hash-link" aria-label="Direct link to Don‚Äôt guide attackers" title="Direct link to Don‚Äôt guide attackers">‚Äã</a></h3>
<p>Unless you reveal your technology stack or maintain an open-source application, attackers will scan your application to find which technology you are using before they try to exploit it.</p>
<p>There are plenty of template engines out there, and only by finding which technology is used in rendering them, attackers will save a lot of time that we would take in scanning and brute-forcing.</p>
<p>To hide which backend technology is used in your backend, or at least your front-end rendering service, we can follow these recommendations:</p>
<ul>
<li>Make sure to not log any debug messages on the front-end and disable debug mode in your framework.</li>
<li>Use non-standard framework error pages/messages, consider catching errors and returning your custom error pages. You can make them static (not rendering any variable or expression) unless you can really justify it.</li>
<li>Remove <code>X-Powered-By</code>, <code>Server</code>, and any other HTTP headers that would expose your application server (e.g. <code>X-AspNet-Version</code>), or just a library like <a href="https://helmetjs.github.io/" target="_blank" rel="noopener noreferrer">Helmet</a> for Node.js.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="do-not-trust-your-client-facing-renderer-application">Do not trust your client-facing renderer application<a href="https://fcmam5.me/blog/ctf-as-a-developer-pt-1-template-engines-ssti#do-not-trust-your-client-facing-renderer-application" class="hash-link" aria-label="Direct link to Do not trust your client-facing renderer application" title="Direct link to Do not trust your client-facing renderer application">‚Äã</a></h3>
<p>If you are working on a critical application, you might be already applying a zero-trust system which would also affect your application deployment and architecture.</p>
<p>In case your renderer application is containerized, you can consider using distroless images which is a minimalistic setup for your application (removing shell and its utilities) which would limit what can be done if someone took over your application.</p>
<p>Running application processes as a non-root user, and having its filesystem set to read-only in addition to limiting its network access to internal infrastructure.</p>
<p>That may protect the infrastructure from having a backdoor in the renderer.</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="final-thoughts">Final thoughts<a href="https://fcmam5.me/blog/ctf-as-a-developer-pt-1-template-engines-ssti#final-thoughts" class="hash-link" aria-label="Direct link to Final thoughts" title="Direct link to Final thoughts">‚Äã</a></h2>
<p>We humans are the most vulnerable piece of any complex software system. We can introduce serious security flaws by being lazy or not taking things seriously or by sacrificing best practices for the sake of speed of delivery.</p>
<p>SSTI is an example of vulnerabilities that might be easy to avoid by just educating ourselves that it‚Äôs a risk, by spending some time adapting well-maintained templating engines and keeping them up-to-date or at least updating them when security patches are released.</p>
<p>Adapting templating engines should be done with best practices and security by default. Then developers should have a good code review culture to make sure that libraries are used and configured as they should be.</p>
<p>If you are reading this blog and you are also one of us, who only learn by doing and by breaking things, have a look at these challenges from HackThe box:</p>
<ul>
<li><a href="https://app.hackthebox.com/challenges/395" target="_blank" rel="noopener noreferrer">https://app.hackthebox.com/challenges/395</a></li>
<li><a href="https://app.hackthebox.com/challenges/152" target="_blank" rel="noopener noreferrer">https://app.hackthebox.com/challenges/152</a></li>
</ul>
<p>Or, you can use these applications that are explicitly made to be vulnerable:</p>
<ul>
<li><a href="https://owasp.org/www-project-juice-shop/" target="_blank" rel="noopener noreferrer">https://owasp.org/www-project-juice-shop/</a></li>
<li><a href="https://github.com/OWASP/NodeGoat" target="_blank" rel="noopener noreferrer">https://github.com/OWASP/NodeGoat</a></li>
<li><a href="https://github.com/appsecco/dvna" target="_blank" rel="noopener noreferrer">https://github.com/appsecco/dvna</a></li>
<li><a href="https://github.com/CTFd/CTFd" target="_blank" rel="noopener noreferrer">https://github.com/CTFd/CTFd</a></li>
</ul>
<p>Or this lab from PortSwigger‚Äôs <a href="https://portswigger.net/web-security" target="_blank" rel="noopener noreferrer">Web Security Academy</a>:</p>
<p><a href="https://portswigger.net/web-security/server-side-template-injection/exploiting" target="_blank" rel="noopener noreferrer">https://portswigger.net/web-security/server-side-template-injection/exploiting</a></p>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="resources">Resources<a href="https://fcmam5.me/blog/ctf-as-a-developer-pt-1-template-engines-ssti#resources" class="hash-link" aria-label="Direct link to Resources" title="Direct link to Resources">‚Äã</a></h3>
<ul>
<li><a href="https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/18-Testing_for_Server-side_Template_Injection" target="_blank" rel="noopener noreferrer">https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/18-Testing_for_Server-side_Template_Injection</a></li>
<li><a href="https://www.vaadata.com/blog/server-side-template-injection-vulnerability-what-it-is-how-to-prevent-it/" target="_blank" rel="noopener noreferrer">https://www.vaadata.com/blog/server-side-template-injection-vulnerability-what-it-is-how-to-prevent-it/</a></li>
<li><a href="https://portswigger.net/research/server-side-template-injection" target="_blank" rel="noopener noreferrer">https://portswigger.net/research/server-side-template-injection</a></li>
</ul>]]></content:encoded>
            <category>backend</category>
            <category>cybersecurity</category>
            <category>frontend</category>
        </item>
        <item>
            <title><![CDATA[Trying to become a better developer by learning more about¬†aviation]]></title>
            <link>https://fcmam5.me/blog/trying-to-become-a-better-developer-by-learning-more-about-aviation</link>
            <guid>https://fcmam5.me/blog/trying-to-become-a-better-developer-by-learning-more-about-aviation</guid>
            <pubDate>Sun, 23 Jul 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[What I learned from aviation as a software engineer.]]></description>
            <content:encoded><![CDATA[<p>In the last few months, I started geeking more about aviation-related topics. Mostly by watching A LOT of videos explaining how things work, and how accidents happened in that highly regulated and safe field.</p>
<p>I really don‚Äôt know why the aviation domain precisely but, I think it has a sweet spot for me where I learn new things, while I let go of things I don‚Äôt understand very well so that I don‚Äôt dive too deep into searching and reading. For example, I can understand what ‚ÄúWake turbulence‚Äù is, but I can‚Äôt explain it in physics terms, which is fine for a hobbyist.</p>
<p>In a journey to become a better software engineer, I believe it‚Äôs necessary to continuously improve my ‚ÄúEngineer reflexes and intuitions‚Äù, if I can call it that. It‚Äôs basically having that sense that made seniors I worked with say: No I don‚Äôt like that solution, I think it will cause XYZ. An answer like that was impressive to me, how could they bring all those exceptions and edge cases to the table and be that proactive?</p>
<div class="theme-admonition theme-admonition-note admonition_YnoO alert alert--secondary"><div class="admonitionHeading_YJrT"><span class="admonitionIcon_lSVy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_gK7M"><p>I published this article previously on Medium: <a href="https://medium.com/@Fcmam5/trying-to-become-a-better-developer-by-learning-more-about-aviation-5241e7092f7e" target="_blank" rel="noopener noreferrer">Trying to become a better developer by learning more about aviation</a>, it was - by far - my most popular post ever.</p></div></div>
<p>The answer was partially in the many aviation videos I watched: It‚Äôs in training, a lot of training, and in learning about others‚Äô mistakes (because we can‚Äôt afford to try them on our own) and in talking and reading, being open and up to date.</p>
<p>In a high-risk field, you would have smart people who are specialists in risk management, and together with engineers and inspectors they usually bring up standards, best practices, and patterns and concepts to follow.</p>
<p><img decoding="async" loading="lazy" alt="Air Alg√©rie Flight 702P (Boeing 737) in the simulator from Mentour Pilot‚Äôs video" src="https://fcmam5.me/assets/images/header-875c369358734bf131bf0d772601e849.png" width="2852" height="1446" class="img_WapC"></p>
<p>From those concepts, I learned about:</p>
<p><strong>‚ÄúAviate, Navigate, Communicate‚Äù</strong> axiom</p>
<p>When things go wrong pilots are trained to focus on actually keeping the airplane in the air, then they navigate. They decide where to go and land somewhere, and only when clearing that out do they communicate with Air traffic controllers, crew members and/or passengers.</p>
<p>We can also adopt similar practices as software engineers, or at least get inspired by them. For example, when dealing with production outages, it is more important sometimes to just keep production running and keep serving the users. Only after ensuring that, we may start looking into debugging and fixing those root causes. One of the most stressful things we go through during incidents is when POs or different managers come (or start calling) to ask for reports asking what happened and what is the estimated time to XYZ.</p>
<p>I believe that engineers should first focus on fixing the problems and then they can jot down a postmortem report, or if possible they would delegate one communicator in the team who will be their only proxy to other parties. The communicator in charge will block the unnecessary panic questions, and will only report the team's findings and not their hypotheses.
If you are an application owner, who needs to communicate to their users, you don't want to communicate what your engineers "think is the reason", or that "the fix may work", you just want to be sure and let your engineers do their jobs properly. So as in aviation: Communicate, comes after Aviate and Navigate.</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="dr-reasons-swiss-cheesemodel">Dr. Reason's Swiss cheese&nbsp;model<a href="https://fcmam5.me/blog/trying-to-become-a-better-developer-by-learning-more-about-aviation#dr-reasons-swiss-cheesemodel" class="hash-link" aria-label="Direct link to Dr. Reason's Swiss cheese&nbsp;model" title="Direct link to Dr. Reason's Swiss cheese&nbsp;model">‚Äã</a></h2>
<p>Airplanes go through rough testing procedures. And before each flight, multiple parties need to check for different parts of the aircraft and its flight program.</p>
<p>Maintenance staff must check the airplanes regularly, and before each flight, the pilots have a mandatory pre-flight check to perform from outside the aircraft and inside the cockpit. Each of these checks is a defense layer, and each layer might not be perfect due to human errors or lack of observations, or maybe the flaws are just hard or impossible to find easily.</p>
<p><img decoding="async" loading="lazy" alt="Swiss cheese model‚Ää-‚ÄäWikipedia" src="https://fcmam5.me/assets/images/swiss-cheese-model-b6158b86eb9f97052e01bb53fef76224.png" width="1600" height="584" class="img_WapC"></p>
<p>This situation where flaws can bypass the many defense layers due to hazards and accidents leads to major accidents happening when all holes of the cheese are lined up which defined what's called a <a href="https://en.wikipedia.org/wiki/Swiss_cheese_model" target="_blank" rel="noopener noreferrer">"Dr. Reason's Swiss cheese model"</a>.</p>
<p>As software engineers, we have multiple defense layers to protect our applications, to ensure that our code is running as expected all the time.</p>
<p>These layers are defined by our code reviews, different test classes, and working with QA, security, and Operation teams.</p>
<p>In more critical environments, regulations may enforce having more layers, more SDLC controls, and even more "bureaucratic" operations to fulfill. This may create an unpleasant and unagile environment for us, the engineers, but it may make sense to protect our organization and our users as much as possible.</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="build-for-resiliency-and-designed-to-failsafely">Build for resiliency and designed to fail&nbsp;safely<a href="https://fcmam5.me/blog/trying-to-become-a-better-developer-by-learning-more-about-aviation#build-for-resiliency-and-designed-to-failsafely" class="hash-link" aria-label="Direct link to Build for resiliency and designed to fail&nbsp;safely" title="Direct link to Build for resiliency and designed to fail&nbsp;safely">‚Äã</a></h2>
<p>Airplanes and pilots go through rough tests and simulations to prove their resilience, and even with that aircraft are designed and equipped to crash-land safely, they are equipped to land on water as well as land. Pilots are trained to fly and land in difficult situations that sometimes seem impossible.</p>
<p>As a software engineer, I always strive to build resilient and stable pieces of software, and I try my best to test it and cover as many edge cases as possible with different test suites. Even with that, I set it up to fail safely, it is cheaper to invest time and effort to design graceful shutdown mechanisms, error handling, and alerting system is better than having to debug or resolve issues in darkness when they happen in production.</p>
<p>Admitting that things can go wrong is an act of humbleness and engineering wisdom and an acknowledgment of common fallacies (such as the network being reliable, especially when operating on public Clouds). This makes me prepare for incidents and outages and feel comfortable with breaking things in DEV and staging environments. This will "prove" that other pieces of the system are resilient to continue operating, or at least not causing a domino effect.</p>
<p>As humans, we cannot always make smart decisions when being under stress, we tend to give up on our reflexes. And the only smart way to prepare for chaos is to train ourselves for those moments, to actually program our reflexes to do the "right" things, or at least to not panic and make more incidents look like other any other events happening at the job.</p>
<p>In a great talk by Amazon, this was addressed by AWS's Resilience Engineering team who are trained as firefighters who are trained for hours to handle emergencies.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/ztiPjey2rfY?si=PHZiLg1wQ_iCyRn4" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin"></iframe>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="checklists-runbooks-and-notes">Checklists, Runbooks, and notes<a href="https://fcmam5.me/blog/trying-to-become-a-better-developer-by-learning-more-about-aviation#checklists-runbooks-and-notes" class="hash-link" aria-label="Direct link to Checklists, Runbooks, and notes" title="Direct link to Checklists, Runbooks, and notes">‚Äã</a></h2>
<p>I learned that pilots have checklists for many scenarios, and they are continually checked and followed even if the pilots are operating the same airplane for long hours and probably flew and landed it hundreds of times, they still follow the same checklists because they don‚Äôt want to miss any tiny detail.</p>
<p>These checklists can also cover incidents and what to do when a certain problem occurs, they may cover things that seem obvious to anyone but under stress, tiredness, and confusion they might be missed or done in the wrong way which can be fatal.</p>
<p>In addition to checklists, I learned that pilots communicate and keep a log of their actions, for example when taking off, the pilot will communicate their V1, VR, and V2, then they announce the speed when reaching it during the takeoff.</p>
<p>This is a learning for me as a software engineer, it is good practice to write Runbooks and keep notes whenever possible when designing, developing, and debugging software. This might come in handy to trace back issues or to learn and have the narrative behind decisions that are implemented.</p>
<p>Maintaining troubleshooting guides is crucial to easily and quickly debug and spot common errors that might happen in the past, or that are expected, these guides should be maintained and updated with new learnings and incidents that can be mitigated in the future.</p>
<p>We are humans, we forget a lot and we don‚Äôt know how to act well under stress, and also, we can‚Äôt always have the same people who debugged a certain problem on-call 24/7, we must learn from them for the best of everyone.</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="its-a-semi-automated-environment">It‚Äôs a Semi-automated environment<a href="https://fcmam5.me/blog/trying-to-become-a-better-developer-by-learning-more-about-aviation#its-a-semi-automated-environment" class="hash-link" aria-label="Direct link to It‚Äôs a Semi-automated environment" title="Direct link to It‚Äôs a Semi-automated environment">‚Äã</a></h2>
<p>Autopilots nowadays are smart, they can fly and land an aircraft, and still, we need pilots to handle some situations manually.</p>
<p>When the autopilot is flying the airplane, the pilot would be more in the monitoring mission. Air traffic controllers as well rely on instruments and ‚Äúintelligent‚Äù software, but we still rely on the human factor to take decisions and to watch these instruments because software can be faulty, or it just cannot cover edge cases (like what happened in <a href="https://www.youtube.com/watch?v=nj7nG6gJqsU" target="_blank" rel="noopener noreferrer">06L at Toronto airport</a>).</p>
<p>Same as with software engineering, we have a lot of development, debugging, orchestrating, and monitoring tools that can do a lot for us but we still need to manage and configure them and sometimes just do things by ourselves since we might reach their limitations or we have an edge case that wasn‚Äôt covered when they were built.</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="have-a-ubiquitous-language">Have a ‚ÄúUbiquitous language‚Äù<a href="https://fcmam5.me/blog/trying-to-become-a-better-developer-by-learning-more-about-aviation#have-a-ubiquitous-language" class="hash-link" aria-label="Direct link to Have a ‚ÄúUbiquitous language‚Äù" title="Direct link to Have a ‚ÄúUbiquitous language‚Äù">‚Äã</a></h2>
<p>Pilots who fly internationally don‚Äôt only have to speak English, but they also have to use unambiguous jargon, they even have to spell important words in <a href="https://en.wikipedia.org/wiki/NATO_phonetic_alphabet" target="_blank" rel="noopener noreferrer">NATO Phonetic alphabet</a> (Alpha, Bravo, Charlie‚Ä¶). It is expected from any pilots, ATC operator, and investigator to differentiate between a Mayday and a PAN-PAN, to understand what airborne and ‚Äúhold short‚Äù mean.</p>
<p>Similarly, as software engineers, we do have our vocabulary, our wordings, and expressions but we sometimes tend to misuse some of them, or we don‚Äôt pay attention to how words can have a huge impact on some of our decisions.</p>
<p>The term ‚ÄúUbiquitous language‚Äù was used by Eric Evans in his book <a href="https://www.amazon.de/Domain-Driven-Design-Tackling-Complexity-Software/dp/0321125215" target="_blank" rel="noopener noreferrer">Domain-Driven Design: Tackling Complexity in the Heart of Software</a>, to define and build a common language between developers and different parties working and using the application, this ubiquitous language, when used in conversations between developers, testers, product owners and domain experts, based on a domain model that evolves with the product and with the team‚Äôs understanding of the domain.</p>
<p>The common understanding and using the same common language should also affect the ‚ÄúDoD and DoR‚Äù, which always cause friction between business, product, development, and Ops teams. When ‚ÄúReady‚Äù and ‚ÄúDone‚Äù definitions are not clear, engineers may start working on tickets with undefined or unclear requirements which may lead to either an incomplete or an overengineered solution. And if the definition of ‚ÄúDone‚Äù is not clear, product and business teams may lose track of what the development team is working on, or developers may push incomplete features that might not be signed by QA.</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="design-good-enough-monitoring-dashboards">Design good enough monitoring dashboards<a href="https://fcmam5.me/blog/trying-to-become-a-better-developer-by-learning-more-about-aviation#design-good-enough-monitoring-dashboards" class="hash-link" aria-label="Direct link to Design good enough monitoring dashboards" title="Direct link to Design good enough monitoring dashboards">‚Äã</a></h2>
<p>Monitoring aircraft, weather radars, and airports is a vital part of aviation. Sensors and computers are getting smarter and more accurate and that only can help pilots be more proactive, they can spot problems in their early stages and solve them seamlessly. But when technology fails to deliver, pilots‚Äô experience and training come to debug and find optimal solutions to overcome issues.</p>
<p>As software engineers we also care about our health checks, our metrics, and alerts, we may even go a little bit crazy and have verbose logs and over-crowded dashboards of metrics we rarely care about. We can have that as a learning and make sure to have habits to check monitoring dashboards regularly.</p>
<p>As developers, we love tools, we love dashboards, and we all love seeing our health checks green with no crazy spikes when we leave for our weekends. But experience and horror stories showed us that sometimes these monitoring dashboards might not be reliable and most of the time it‚Äôs because of the way we set them up, and a few times they‚Äôre buggy or affected by infrastructure outages, for example, this:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/mrp1F2rezdw?si=WmeRbiD8aiUS9Ufr&amp;start=2278" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin"></iframe>
<p>This and other lessons taught us that we should invest in having a set of health checks and monitoring dashboards, and all of them need to be carefully set up.</p>
<p>One other thing to consider is that we need to avoid noise when it comes to dashboards, we should have a smart optimal set of metrics and views to monitor or it will be overwhelming to process what‚Äôs going wrong by looking at the screen regularly.</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="treat-warnings-and-alerts-as-warnings-and-alerts">Treat warnings and alerts as WARNINGS and ALERTS!<a href="https://fcmam5.me/blog/trying-to-become-a-better-developer-by-learning-more-about-aviation#treat-warnings-and-alerts-as-warnings-and-alerts" class="hash-link" aria-label="Direct link to Treat warnings and alerts as WARNINGS and ALERTS!" title="Direct link to Treat warnings and alerts as WARNINGS and ALERTS!">‚Äã</a></h2>
<p>We are all guilty of ignoring warnings in our applications and different monitoring and scanning consoles. We think that we know that some of them are false positives, irrelevant, not urgent, or just another ‚Äúnot my problem‚Äù labeled thing.</p>
<p>After a while we get immune, we stop caring and noticing ‚Äúreal warnings‚Äù when they happen so we don‚Äôt act on them on time.</p>
<p>Alerts are even more critical, and similarly to aviation fields, if they happen we should <strong>really</strong> react to that, if we ever think that alert is a false positive one, we should try to tag it so we can improve our alerting and monitoring systems. We don‚Äôt want to become numb to these alerts so we just ignore them or treat them seriously and react to them in time.</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="simulators">Simulators<a href="https://fcmam5.me/blog/trying-to-become-a-better-developer-by-learning-more-about-aviation#simulators" class="hash-link" aria-label="Direct link to Simulators" title="Direct link to Simulators">‚Äã</a></h2>
<p>Pilots spend hours training on simulators that are as realistic as it gets before they actually start flying real planes.</p>
<p>And that‚Äôs a lesson for us, as expensive as it is to have staging and/or pre-prod environments that are protected and close to production they might be cheaper than dealing with problems in production. These environments must be kept clean and protected as we would treat production to see how our applications can be deployed and run without any hacks or manual interventions from us, while we may lose restrictions on DEV environments and give developers more freedom to experiment and safely break things.</p>
<p>One other lesson we learn from simulators is again: Everyone needs training. We don‚Äôt want improvisations and risky fixes on production.</p>
<p>As referred to in the talk I shared from AWS team, they make sure to train their engineers to handle outages so that when that happens they know what to do without panicking (hopefully).</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="no-matter-how-experienced-you-are-take-your-time-learning-new-tools">No matter how experienced you are, take your time learning new tools<a href="https://fcmam5.me/blog/trying-to-become-a-better-developer-by-learning-more-about-aviation#no-matter-how-experienced-you-are-take-your-time-learning-new-tools" class="hash-link" aria-label="Direct link to No matter how experienced you are, take your time learning new tools" title="Direct link to No matter how experienced you are, take your time learning new tools">‚Äã</a></h2>
<p>A pilot‚Äôs experience is evaluated by their flying hours, and when a certain pilot is flying commercially they‚Äôre evaluated by their total flying hours and the number of hours they flew on that type (particular airplane model).</p>
<p>As software engineers, we have a big ego, we think we are smart and we know that after years of experience, we can absorb anything new in our ecosystem easily.</p>
<p>As a JavaScript developer, I‚Äôm confident that I can switch to any framework and library just by spending a few hours looking into the documentation or by reading other people‚Äôs code examples, after all, it‚Äôs just JavaScript. However, with that mentality and with some over-confidence I may overlook certain caveats, or certain ‚Äúgood practices‚Äù if I don‚Äôt pay enough attention to the documentation and give new tools, concepts, and technologies their fair amount of time and focus.</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="take-rest-respect-your-time-off-if-you-care-about-your-job">Take rest, respect your time off if you care about your job<a href="https://fcmam5.me/blog/trying-to-become-a-better-developer-by-learning-more-about-aviation#take-rest-respect-your-time-off-if-you-care-about-your-job" class="hash-link" aria-label="Direct link to Take rest, respect your time off if you care about your job" title="Direct link to Take rest, respect your time off if you care about your job">‚Äã</a></h2>
<p>Fatigue is a major factor in many accidents. That made regulators and companies ensure, and enforce having a good amount of rest for pilots.</p>
<p>If pilots operate for long hours or they did not have quality rest they will have poor judgment, decision-making, and flying abilities. This may cause a failure in assessing different flying scenarios and challenges.</p>
<p>While writing this article, one of my favorite aviation channels published this video about my country‚Äôs aviation company. It fits perfectly with, this section‚Äôs point so I thought I would speak about it here:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/o57gCc-_oPY?si=be5JuUCAxeI72K6x" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin"></iframe>
<p>As software engineers, we do relate to situations where tiredness can cause a fatal accident. How many times have we thought we‚Äôd push ourselves and work for extra minutes and ended up creating bugs and incidents that took us hours to fix?</p>
<p><img decoding="async" loading="lazy" alt="Monkeyuser: Quick fix" src="https://fcmam5.me/assets/images/monkeyuser-quickfix-6a4206182afedc7fad3df75290857252.png" width="1400" height="1523" class="img_WapC"></p>
<p>The moral of this was synthesized in Uncle Bob‚Äôs Clean Coder book:</p>
<blockquote>
<p>‚ÄúDon‚Äôt write code when you are tired. Dedication and professionalism are more about discipline than hours. Make sure that your sleep, health, and lifestyle are tuned so that you can put in eight good hours per day.‚Äù ‚Äî Robert C. Martin (Uncle Bob), The clean coder</p>
</blockquote>
<p>And:</p>
<blockquote>
<p>‚ÄúIf you are tired or distracted, do not code. You‚Äôll only wind up redoing what you did. Instead, find a way to eliminate the distractions and settle your mind.‚Äù ‚Äî Robert C. Martin (Uncle Bob), The clean coder</p>
</blockquote>
<p>One other trap we may fall into is that ‚Äúif I ever stop here I would forget where I stopped‚Äù or something like ‚ÄúI‚Äôm sick of this and I want to start my next day by working on something other than this‚Äù And we end up rushing, designing and writing things we forget due to fatigue later and might also clumsy and be of low quality.</p>
<blockquote>
<p>‚ÄúCan‚Äôt go home till you solve this problem? Oh yes you can, and you probably should! Creativity and intelligence are fleeting states of mind. When you are tired, they go away. If you then pound your nonfunctioning brain for hour after late-night hour trying to solve a problem, you‚Äôll simply make yourself more tired and reduce the chance that the shower, or the car, will help you solve the problem.
When you are stuck, when you are tired, disengage for awhile. Give your creative subconscious a crack at the problem. You will get more done in less time and with less effort if you are careful to husband your resources.‚Äù ‚Äî Robert C. Martin (Uncle Bob), The clean coder</p>
</blockquote>
<p>I learned that taking time off and having real weekends and vacations is an investment in your professional life. In your time off, you don‚Äôt work, don‚Äôt think about work, and only care about your health, family, and enjoying your time. Once you are back, you will find yourself more motivated, more focused and, your passion or your interest refreshed.</p>]]></content:encoded>
            <category>development</category>
        </item>
        <item>
            <title><![CDATA[I‚Äôm learning front-end development, again ‚Äî Part 1 (Browser rendering optimization)]]></title>
            <link>https://fcmam5.me/blog/learning-front-end-development-again-part-1-browser-rendering-optimization</link>
            <guid>https://fcmam5.me/blog/learning-front-end-development-again-part-1-browser-rendering-optimization</guid>
            <pubDate>Sun, 06 May 2018 00:00:00 GMT</pubDate>
            <description><![CDATA[TLDR; I disregarded front-end development until I started reading about some of its advanced concepts and challenges, I learned more about browser rendering optimization, website performances, and web accessibility. In this article, I‚Äôm going to share some notes I took when learning browser rendering optimization.]]></description>
            <content:encoded><![CDATA[<p><em>TLDR; I disregarded front-end development until I started reading about some of its advanced concepts and challenges, I learned more about browser rendering optimization, website performances, and web accessibility. In this article, I‚Äôm going to share some notes I took when learning browser rendering optimization.</em></p>
<div class="theme-admonition theme-admonition-note admonition_YnoO alert alert--secondary"><div class="admonitionHeading_YJrT"><span class="admonitionIcon_lSVy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_gK7M"><p>I published this article previously on Medium: <a href="https://medium.com/@Fcmam5/im-learning-front-end-development-again-part-1-browser-rendering-optimization-c8359ee90c40" target="_blank" rel="noopener noreferrer">I‚Äôm learning front-end development, again ‚Äî Part 1 (Browser rendering optimization)</a></p></div></div>
<p>I thought that front-end development was only about making beautiful user interfaces, responsive and mobile-friendly websites that load fast. I imagined that a Front-end Developer was someone who knows more HTML tags, CSS properties and knows how to manipulate DOM with and/or without jQuery, and who knows how things should look and feels when using his applications, and that a front-end developer is only a creative person who knows how to convert mockups to HTML and CSS, who works with React, Angular and Vue.js. And that the backend developer is the smart developer who does the big things in any web application, this one -for me- who‚Äôs responsible for the hard part by dealing with a database, Files I/O, authentication, security, and performance...</p>
<p>Apparently, working with HTML, CSS, and JavaScript and designing user interfaces is not that interesting like building backends and dealing with ‚Äúreal challenges‚Äù, so why do companies invest in recruiting front-end developers for ‚ÄúJust designing interfaces‚Äù? Why front-end development is a separate and well-paid specialty? Looking for an answer, I started a journey of reading and learning ‚ÄúAdvanced front-end development‚Äù articles and lessons to know how it feels to be a front-end developer, what are their/our challenges, and why there are people specialized in that.</p>
<p>This week, I will be reading and taking notes for what I learned, if it seems complicated, boring or confusing to you, that will be the answer to my questions, it will explain why there are front-end developers, the persons who care about all of that and maybe more!</p>
<p>The journey will be guided by <a href="https://frontendmasters.com/books/front-end-handbook/2018/" target="_blank" rel="noopener noreferrer">FrontEnd developer handbook 2018</a>. So let‚Äôs get started in learning front-end development.</p>
<p>First, as front-end developers, we shouldn‚Äôt only design beautiful websites. We must take care of things beyond the good-looking design, as specialists and developers, building usable, accessible, and performant web pages is our challenge.</p>
<p>It seems challenging, Nice!<br>
Let‚Äôs get it started.</p>
<h2 class="anchor anchorWithStickyNavbar_kJUw" id="website-performances">Website performances<a href="https://fcmam5.me/blog/learning-front-end-development-again-part-1-browser-rendering-optimization#website-performances" class="hash-link" aria-label="Direct link to Website performances" title="Direct link to Website performances">‚Äã</a></h2>
<blockquote>
<p>Bad performance kills good sites ‚Äî <a href="https://twitter.com/aerotwist" target="_blank" rel="noopener noreferrer">Paul Lewis</a> at <a href="https://classroom.udacity.com/courses/ud860/lessons/4138328558/" target="_blank" rel="noopener noreferrer">ud860</a></p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="how-browsers-works">How browsers works<a href="https://fcmam5.me/blog/learning-front-end-development-again-part-1-browser-rendering-optimization#how-browsers-works" class="hash-link" aria-label="Direct link to How browsers works" title="Direct link to How browsers works">‚Äã</a></h3>
<p>We can‚Äôt optimize or work on websites performances without knowing how the browsers that display their UIs work.</p>
<p><img decoding="async" loading="lazy" alt="Quantum Up close: What is a browser engine" src="https://fcmam5.me/assets/images/browser-engine-df0d40552f1d8858e1a40d758262b1c1.png" width="1200" height="320" class="img_WapC"></p>
<p>So let‚Äôs look under the hood.</p>
<p><img decoding="async" loading="lazy" alt="Browser components ‚Äî HTML5 Rocks" src="https://fcmam5.me/assets/images/browser-components-da090380db95b6066291083f7e3e33ba.png" width="500" height="339" class="img_WapC"></p>
<p>Web browsers are composed of a UI, a browser engine that transfers the actions between the UI and the rendering engine, the rendering engine displays the HTML and CSS after parsing it. Browsers also have a data storage layer where data are stored locally as cookies, localStorage, and also IndexedDB, WebsSQL, and FileSystem. There‚Äôs also networking (Where HTTP, DNS‚Ä¶ are handled), JS interpreter, and UI backend.</p>
<p><img decoding="async" loading="lazy" alt="Quantum Up close: What is a browser engine" src="https://fcmam5.me/assets/images/what-is-browser-engine-e969186a1e23f5e9dff4996f8213cc3f.png" width="1650" height="1490" class="img_WapC"></p>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="render-tree">Render Tree<a href="https://fcmam5.me/blog/learning-front-end-development-again-part-1-browser-rendering-optimization#render-tree" class="hash-link" aria-label="Direct link to Render Tree" title="Direct link to Render Tree">‚Äã</a></h3>
<p>Browser engines parse the HTML and CSS, construct the DOM, calculate the styles and display the web page after composing multiple layers.</p>
<p>After parsing HTML, the browser start constructing the render tree, it‚Äôs like the DOM tree with no <code>&lt;head&gt;</code> element, no hidden elements by <code>display:none</code> and with CSS pseudo-elements added to the tree-like</p>
<div class="language-css codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-css codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token selector" style="color:#00009f">h1</span><span class="token selector pseudo-element" style="color:#00009f">::before</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token property" style="color:#36acaa">content</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Hello Africa"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Will construct a node like the DOM‚Äôs nodes. After this step, CSS will be added alongside media, the web page will be composited by multiple layers.</p>
<p>Read more at:</p>
<ul>
<li><a href="https://www.html5rocks.com/en/tutorials/internals/howbrowserswork/" target="_blank" rel="noopener noreferrer">HTML5Rocks : How browsers work</a></li>
<li><a href="https://hacks.mozilla.org/2017/05/quantum-up-close-what-is-a-browser-engine/" target="_blank" rel="noopener noreferrer">Quantum Up close: What is a browser engine</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="optimize-the-browser-rendering">Optimize the browser rendering<a href="https://fcmam5.me/blog/learning-front-end-development-again-part-1-browser-rendering-optimization#optimize-the-browser-rendering" class="hash-link" aria-label="Direct link to Optimize the browser rendering" title="Direct link to Optimize the browser rendering">‚Äã</a></h3>
<p>Understanding how ‚ÄúBrowsers work‚Äù was to learn ‚ÄúHow to optimize the rendering process‚Äù and to make websites that load and work smoothly. In order to deepen my knowledge and to jump to a practical course, I started <a href="https://classroom.udacity.com/courses/ud860/" target="_blank" rel="noopener noreferrer">Udacity‚Äôs Browser optimization</a> course, where I understood more core concepts of browser rendering. Now, let‚Äôs dive into the rendering process.</p>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="60fps-and-device-refresh-rates">60fps and Device Refresh Rates<a href="https://fcmam5.me/blog/learning-front-end-development-again-part-1-browser-rendering-optimization#60fps-and-device-refresh-rates" class="hash-link" aria-label="Direct link to 60fps and Device Refresh Rates" title="Direct link to 60fps and Device Refresh Rates">‚Äã</a></h3>
<p>Users expect the web page that they are visiting to be interactive and smooth, working on web performance doesn't mean we only need to make pages load fast, but we need to make sure that they are running, scrolling fast, animations should be smooth.</p>
<p>HTML, CSS, and JavaScript are handled by browsers, most devices running these browsers refresh their screens 60 times a second (it means that we have 60FPS or one Frame per 16.6666ms). All our animations should be under a score of 10ms (source: <a href="https://developers.google.com/web/fundamentals/performance/rendering/" target="_blank" rel="noopener noreferrer">Google Developers: Rendering performance</a>).</p>
<p>In order to achieve that, we must know more about the Pixel pipeline.</p>
<p><img decoding="async" loading="lazy" alt="The pixel pipeline, source: Google Developers: Rendering performance" src="https://fcmam5.me/assets/images/rendering-cycle-d08eb77e5aa1a1c5d8aff0b00a2ba7bb.png" width="1093" height="167" class="img_WapC"></p>
<ul>
<li><strong>JavaScript</strong> most of the time, JS is used to make visual changes to our web pages, by adding DOM elements to our pages, changing styles‚Ä¶</li>
<li><strong>Style calculations</strong> are the process of calculating what CSS rules to apply on which element based on matching selectors.</li>
<li><strong>Layout</strong> is the process of calculating spaces, widths of the <code>&lt;body&gt;</code> element, and its children's widths.</li>
<li><strong>Paint</strong> is the process of filling in pixels by drawing out texts, colors, images, shadows, and every visual part of each element, drawing is done onto multiple layers.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Firefox‚Äôs 3D view ‚Äî Firefox Developers tools" src="https://fcmam5.me/assets/images/ffx-3d-view-7aadaa7ebfa440569b9c86e61ed98d8e.png" width="973" height="602" class="img_WapC"></p>
<ul>
<li><strong>Compositing</strong> is the process of calculating and drawing each element‚Äôs order so that the page renders correctly.</li>
</ul>
<p>We won‚Äôt always solicit every part of the pipeline on every frame, the fewer properties are changed the fewer calculations we do.</p>
<p>This part taught me that some tasks are more expensive than others, some CSS properties like changing a certain element‚Äôs position may cause Style calculations, Layout calculations, Paint and composite processes and that‚Äôs expensive. While changing the <code>cursor</code> property won‚Äôt affect the layout or painting, it will be carried out by the compositor thread with the help of the GPU.</p>
<p><img decoding="async" loading="lazy" alt="Cursor CSS property on CSS Triggers" src="https://fcmam5.me/assets/images/cursor-css-c13fec412c67e9299bda694b76b83629.png" width="922" height="380" class="img_WapC"></p>
<blockquote>
<p>Performance is the art of avoiding work, and making any work you do as efficient as possible. ‚Äî <a href="https://developers.google.com/web/fundamentals/performance/rendering/" target="_blank" rel="noopener noreferrer">Google Developers: Rendering performance</a>.</p>
</blockquote>
<p>I learned all these valuable information from:</p>
<ul>
<li><a href="https://classroom.udacity.com/courses/ud860/lessons/4138328558/concepts/41373290750923" target="_blank" rel="noopener noreferrer">Browser rendering and optimization: Layout and paint</a></li>
<li><a href="https://developers.google.com/web/fundamentals/performance/rendering/" target="_blank" rel="noopener noreferrer">Google Developers: Rendering performance</a></li>
<li><a href="https://csstriggers.com/" target="_blank" rel="noopener noreferrer">CSS Triggers</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="rail-response-animate-idle-load">RAIL (Response, Animate, Idle, Load)<a href="https://fcmam5.me/blog/learning-front-end-development-again-part-1-browser-rendering-optimization#rail-response-animate-idle-load" class="hash-link" aria-label="Direct link to RAIL (Response, Animate, Idle, Load)" title="Direct link to RAIL (Response, Animate, Idle, Load)">‚Äã</a></h3>
<p>RAIL is a performance model, RAIL‚Äôs goals and guidelines help us to ensure a good UX.</p>
<p><img decoding="async" loading="lazy" alt="The 4 parts of the RAILS performance model" src="https://fcmam5.me/assets/images/rails-998a4303426e1743dd643e47c217e01d.png" width="1390" height="504" class="img_WapC"></p>
<p>In Udacity course, the teachers suggested these metrics.</p>
<p><img decoding="async" loading="lazy" alt="Udacity‚Äôs Browser rendering optimization course: RAIL Response" src="https://fcmam5.me/assets/images/rails-udacity-039ca25838ca51c42415582725c9e5e4.png" width="946" height="533" class="img_WapC"></p>
<p>Users dislike when animations aren‚Äôt smooth, with 60 frames rendered every second, animations should be at 16ms per frame. When it comes to response, users want to feel that the results are immediate, any delay between action and reaction is non-accepted.</p>
<p>It is true that mobile users, especially those who are using slow 3G connections, it is a realistic goal to load pages in 5000ms, but they accept to wait for sites to respond to their inputs, not for sites to load. So it is important to load as little data as possible so the user starts using the page while loading the complete extra loadings.</p>
<p>We can also load complex animations upfront (see more about <a href="https://youtu.be/H3z97NcAbCI" target="_blank" rel="noopener noreferrer"><strong>F</strong>irst <strong>L</strong>ast <strong>I</strong>nvert <strong>P</strong>lay</a>).</p>
<p>At the end of this point, I would like to share with you these useful links by <a href="https://developers.google.com/web/fundamentals/performance/rail#tools" target="_blank" rel="noopener noreferrer">Google Developers: RAIL Tools</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="javascript-understand-how-it-works-on-the-browser-then-optimize">JavaScript: Understand how it works on the browser then optimize!<a href="https://fcmam5.me/blog/learning-front-end-development-again-part-1-browser-rendering-optimization#javascript-understand-how-it-works-on-the-browser-then-optimize" class="hash-link" aria-label="Direct link to JavaScript: Understand how it works on the browser then optimize!" title="Direct link to JavaScript: Understand how it works on the browser then optimize!">‚Äã</a></h3>
<p>JavaScript engines in web browsers interpret the JavaScript utilizing JIT compilers to transform the JS code to byte-code.</p>
<p>Each JavaScript engine implements a version of ECMAScript, a JavaScript dialect and that‚Äôs why we have <a href="https://kangax.github.io/compat-table/es6/" target="_blank" rel="noopener noreferrer">different browser support for ES6, ES7 ‚Ä¶</a></p>
<blockquote>
<p>The goal of a JavaScript engine‚Äôs code parsing and execution process is to generate the most optimized code in the shortest possible time. ‚Äî Jen Looper, <a href="https://developer.telerik.com/featured/a-guide-to-javascript-engines-for-idiots/" target="_blank" rel="noopener noreferrer">A Guide to JavaScript Engines for Idiots</a></p>
</blockquote>
<p>JavaScript code, could not be optimized by hacking the ‚Äúmicro-optimizations‚Äù of the JIT compilers.</p>
<p>So, in order to optimize JavaScript, there are many things we should ensure, one of them is to run JavaScript as earlier as possible at the begging of each frame (that‚Äôs why we discussed the pixel pipeline and RAIL).</p>
<p>Modern browsers provide a <code>requestAnimationFrame</code> function that schedules JavaScript to run as earlier as possible at the begging of the frame.</p>
<p><img decoding="async" loading="lazy" alt="Using requestAnimationFrame (example from Udacity‚Äôs course)" src="https://fcmam5.me/assets/images/requestAnimationFrame-002854498ca63825f3d36b87f3f3f93b.png" width="631" height="294" class="img_WapC"></p>
<p>Also, when it comes to ‚ÄúJavaScript optimization‚Äù, Web workers will be our friends, they allow us to run JavaScript on a totally different thread, they can perform I/O without interfering with the main browser thread, Web Workers can communicate with the main JavaScript code (that created it) by messages. Read more at <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers" target="_blank" rel="noopener noreferrer">Web Worker Documentation on MDN</a>.</p>
<p>For example, we gonna pass a string to a worker in workerFile.js the worker will return the message to the main script.</p>
<p>Main script:</p>
<div class="language-javascript codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-javascript codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> worker </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Worker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'workerFile.js'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'message'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Worker said: '</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">postMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'Hello World'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Send data to our worker.</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And workerFile.js (the worker):</p>
<div class="language-javascript codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-javascript codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'message'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">postMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">toUpperCase</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The example is from <a href="https://www.html5rocks.com/en/tutorials/workers/basics/" target="_blank" rel="noopener noreferrer">HTML5Rocks: The basics of Web workers</a>.</p>
<p>When talking about <strong>memory management in JavaScript</strong>, we can only rely on JavaScript‚Äôs <strong>garbage collector</strong>, JavaScript doesn't have memory or pointers management functions such as <code>malloc()</code> and <code>free()</code>, so in this case <strong>Variables Scopes</strong>, and <strong>functions calls</strong>. For example:</p>
<p>When declaring a local variable inside a function, the allocated space for this variable will be freed after using it.</p>
<div class="language-javascript codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-javascript codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">foo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">arg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> bar </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"this is a local variable"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>But, when using global variables accidentally, we will be using a memory space all the time.</p>
<div class="language-javascript codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-javascript codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">foo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">arg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bar </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"this is a hidden global variable"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Another way where global variables could be created accidentally through this when the function is called on the global scope, for example:</p>
<div class="language-javascript codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-javascript codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">foo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">variable</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"potential accidental global"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Foo called on its own, this points to the global object (window)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// rather than being undefined.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">foo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">variable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// will return "potential accidental global" and not undefined</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>This example is taken from an <a href="https://auth0.com/blog/four-types-of-leaks-in-your-javascript-code-and-how-to-get-rid-of-them/" target="_blank" rel="noopener noreferrer">auth0 forum article</a>.</em></p>
<p>Also, sometimes when performing an animation and when working with timers and callbacks, for example <code>setInterval</code> is used to perform a certain temporary animation, then it won‚Äôt be necessary, let‚Äôs check <a href="https://jsfiddle.net/Fcmam5/zswbd3eL/" target="_blank" rel="noopener noreferrer">this example</a>:</p>
<div class="language-javascript codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-javascript codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> clientCountElement </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getElementById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'visitors'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> ourClients </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// returns 100 for example</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> clientCounter </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">setInterval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ourClients </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> clientCounter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clientCounter</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clientCountElement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">innerHTML</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token known-class-name class-name">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">clientCounter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When <code>clientCounter</code> reaches the <code>ourClients</code> the animation will stop, the visitor number won‚Äôt be incremented but the callback will continue the execution. So, the timers like <code>setTimeout</code> and <code>setInterval</code> must be cleared after finishing the desired action. For my example I tried this:</p>
<div class="language-javascript codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-javascript codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> clientCountElement </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getElementById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'visitors'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> ourClients </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// returned 100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> clientCounter </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> animation </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setInterval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ourClients </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> clientCounter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        clientCounter</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        clientCountElement</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">innerHTML</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token known-class-name class-name">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">clientCounter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Here we cleanup after finishing our animation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">clearInterval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">animation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">delete</span><span class="token plain"> animation</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And that created a difference, as in this live preview using <a href="https://developers.google.com/web/tools/chrome-devtools/memory-problems/" target="_blank" rel="noopener noreferrer">Google Chrome‚Äôs Task Manager</a>.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/epkuTNmH7wc?si=gRuTfCjQSAZdvYar" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin"></iframe>
<p>Timers also may cause another problem, they may run at the end of the frame so it may cause us a missing frame.</p>
<p><img decoding="async" loading="lazy" alt="Google developers: Optimize JavaScript execution" src="https://fcmam5.me/assets/images/timers-exec-9ebd7c47275bc6f57902f07430d05011.png" width="1024" height="768" class="img_WapC"></p>
<p>So, the solution for that is ‚ÄúUsing <code>requestAnimationFrame</code>‚Äù. As in this example from <a href="https://developers.google.com/web/fundamentals/performance/rendering/optimize-javascript-execution" target="_blank" rel="noopener noreferrer">Google developers</a>:</p>
<div class="language-javascript codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-javascript codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * If run as a requestAnimationFrame callback, this</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> * will be run at the start of the frame.</span><br></span><span class="token-line" style="color:#393A34"><span class="token doc-comment comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateScreen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">time</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Make visual updates here.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">requestAnimationFrame</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">updateScreen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Another memory leak is <strong>Out of DOM references</strong>, for example when storing a table cell node (<code>&lt;td&gt;</code>), then deleting the table node from the DOM for some reason. The table will be removed from the DOM, but it will stay in memory, the table cell is a child node of <code>&lt;table&gt;</code> and children keep references to their parents, so the reference to the table cell causes the whole table to stay in memory.</p>
<ul>
<li>
<p><a href="https://kangax.github.io/compat-table/" target="_blank" rel="noopener noreferrer">ECMAScript Compatibility table</a></p>
</li>
<li>
<p><a href="https://developer.telerik.com/featured/a-guide-to-javascript-engines-for-idiots/" target="_blank" rel="noopener noreferrer">A Guide to JavaScript Engines for Idiots</a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=pmtwUOHLgq4" target="_blank" rel="noopener noreferrer">Why Is JavaScript So Fast? (aka JavaScript Engines ‚Äî How Do They Even?)</a></p>
</li>
<li>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers" target="_blank" rel="noopener noreferrer">Web Worker Documentation on MDN</a></p>
</li>
<li>
<p><a href="https://www.html5rocks.com/en/tutorials/workers/basics/" target="_blank" rel="noopener noreferrer">HTML5 Rocks: The basics of web workers</a></p>
</li>
<li>
<p><a href="https://developers.google.com/web/fundamentals/performance/rendering/optimize-javascript-execution" target="_blank" rel="noopener noreferrer">Google developers: Optimize JavaScript execution</a></p>
</li>
<li>
<p><a href="https://auth0.com/blog/four-types-of-leaks-in-your-javascript-code-and-how-to-get-rid-of-them/" target="_blank" rel="noopener noreferrer">Auth0: 4 Types of Memory Leaks in JavaScript and How to Get Rid Of Them</a></p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="css-optimizations-matter-too">CSS optimizations matter too!<a href="https://fcmam5.me/blog/learning-front-end-development-again-part-1-browser-rendering-optimization#css-optimizations-matter-too" class="hash-link" aria-label="Direct link to CSS optimizations matter too!" title="Direct link to CSS optimizations matter too!">‚Äã</a></h3>
<p>When optimizing our web pages, we must take care of CSS too. Using <a href="https://en.bem.info/methodology/key-concepts/#bem-entity" target="_blank" rel="noopener noreferrer">BEM (Block Element Modifier) methodology</a> is recommended, it‚Äôs simpler, reusable, and more optimal. It‚Äôs easier for browsers to math CSS classes than to calculate <code>nth-child(n)</code>, it seems logical: Matching an element is faster than calculating ‚ÄúWhich element it is?‚Äù than matching that calculated result.</p>
<p><img decoding="async" loading="lazy" alt="Udacity: Browser rendering (Selector matching)" src="https://fcmam5.me/assets/images/udacity-selector-matching-75897fe4e236f967a7c95133671ef2d2.png" width="1020" height="479" class="img_WapC"></p>
<p>Also, we must <a href="https://developers.google.com/web/fundamentals/performance/rendering/avoid-large-complex-layouts-and-layout-thrashing#avoid_forced_synchronous_layouts" target="_blank" rel="noopener noreferrer">avoid Forced Synchronous Layout</a>. It‚Äôs happened when we force the browser to perform layout earlier with JavaScript, normally the Layout should be changed after style calculations that came after running JavaScript.</p>
<p><img decoding="async" loading="lazy" alt="Udacity: Browser rendering (FSL)" src="https://fcmam5.me/assets/images/fsl-9b2cd401048aa3cc2d55d432ba696c56.png" width="949" height="306" class="img_WapC"></p>
<p>FSL (Forced Synchronous Layout) could be even worse, when not avoiding <a href="https://developers.google.com/web/fundamentals/performance/rendering/avoid-large-complex-layouts-and-layout-thrashing#avoid_layout_thrashing" target="_blank" rel="noopener noreferrer">Layout trashing</a>, like we don‚Äôt care if we calculate widths, heights, margins and offset each time by calling functions like <code>.offsetHeight</code> inside a loop.</p>
<p>For example, this:</p>
<div class="language-javascript codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-javascript codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Read.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> width </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> box</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">offsetWidth</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">resizeAllParagraphsToMatchBlockWidth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> paragraphs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Now write.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    paragraphs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> width </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'px'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Is more optimal than</p>
<div class="language-javascript codeBlockContainer_CAha theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_idsA"><pre tabindex="0" class="prism-code language-javascript codeBlock_h9xo thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Dojk"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">resizeAllParagraphsToMatchBlockWidth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Puts the browser into a read-write-read-write cycle.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> paragraphs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    paragraphs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">style</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> box</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">offsetWidth</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'px'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_kTqz"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_S9YR" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_ut7n"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_PX1_"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Sources:</p>
<ul>
<li>
<p><a href="https://developers.google.com/web/fundamentals/performance/rendering/avoid-large-complex-layouts-and-layout-thrashing" target="_blank" rel="noopener noreferrer">Google Developers: Avoid Large, Complex Layouts and Layout Thrashing</a></p>
</li>
<li>
<p><a href="https://classroom.udacity.com/courses/ud860" target="_blank" rel="noopener noreferrer">Udacity: Browser rendering optimization</a></p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_kJUw" id="measure-first-then-optimize">Measure first, then optimize<a href="https://fcmam5.me/blog/learning-front-end-development-again-part-1-browser-rendering-optimization#measure-first-then-optimize" class="hash-link" aria-label="Direct link to Measure first, then optimize" title="Direct link to Measure first, then optimize">‚Äã</a></h3>
<p><img decoding="async" loading="lazy" alt="Udaciry‚Äôs Browser rendering optimization DevTools Timeline Practice: Measure first" src="https://fcmam5.me/assets/images/focus-on-the-cause-measure-5e1fdbb43e64a617897a95e48a19e3d5.png" width="495" height="238" class="img_WapC"></p>
<p>Google Chrome and Firefox provide powerful testing, debugging, and measurement tools. In <a href="https://classroom.udacity.com/courses/ud860" target="_blank" rel="noopener noreferrer">Udacity‚Äôs course(Under a title of ‚ÄúWeapons of junk destruction‚Äù)</a> I learned a little to how to measure the performance. Firefox also provides a powerful <a href="https://developer.mozilla.org/son/docs/Tools/Performance" target="_blank" rel="noopener noreferrer">Performance measurement tool in his DevTools</a>.</p>
<p>When working on website performance, we must always measure, at the begging and after performing any modifications, we must not ‚Äú<strong>Try to solve problems that we don‚Äôt have</strong>‚Äù.</p>
<p>Somehow, when taking a rest from writing, I visited Facebook where I found that freeCodeCamp posted this great talk!</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/v5r_n6Tq0uk?si=V3IxwaZYrGZTww35" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin"></iframe>
<br>
<p>My first week ends here, and that was what I learned. I really don‚Äôt know ‚ÄúHow it feels to be a front-end developer‚Äù, how do the professional front-end developers work, and do they really care about this? I really want to hear anything from you, the front-end developers especially!</p>
<p>I enjoyed studying this week, I understood the rendering process, and that everything matters. Some of the concepts seemed harder to understand so I looked up to them, I needed more resources to understand them. Trying to take notes about what I‚Äôm learning on this article obliged me to do more efforts to understand all that I need to write, and I needed to write all the interesting things I read, so writing was a motivation for me!</p>]]></content:encoded>
            <category>frontend</category>
            <category>development</category>
        </item>
    </channel>
</rss>
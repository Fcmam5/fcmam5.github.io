<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.1">
<title data-rh="true">Avoiding NestJS performance bottlenecks | Abdeldjalil Fortas&#x27; notepad</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://fcmam5.me/img/karantika.png"><meta data-rh="true" name="twitter:image" content="https://fcmam5.me/img/karantika.png"><meta data-rh="true" property="og:url" content="https://fcmam5.me/blog/avoiding-nestjs-performance-bottlenecks"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Avoiding NestJS performance bottlenecks | Abdeldjalil Fortas&#x27; notepad"><meta data-rh="true" name="description" content="Few tips on how to avoid some of NestJS performance bottlenecks"><meta data-rh="true" property="og:description" content="Few tips on how to avoid some of NestJS performance bottlenecks"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-09-23T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/fcmam5"><meta data-rh="true" property="article:tag" content="backend,nestjs,development"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://fcmam5.me/blog/avoiding-nestjs-performance-bottlenecks"><link data-rh="true" rel="alternate" href="https://fcmam5.me/blog/avoiding-nestjs-performance-bottlenecks" hreflang="en"><link data-rh="true" rel="alternate" href="https://fcmam5.me/blog/avoiding-nestjs-performance-bottlenecks" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://fcmam5.me/blog/avoiding-nestjs-performance-bottlenecks","mainEntityOfPage":"https://fcmam5.me/blog/avoiding-nestjs-performance-bottlenecks","url":"https://fcmam5.me/blog/avoiding-nestjs-performance-bottlenecks","headline":"Avoiding NestJS performance bottlenecks","name":"Avoiding NestJS performance bottlenecks","description":"Few tips on how to avoid some of NestJS performance bottlenecks","datePublished":"2023-09-23T00:00:00.000Z","author":{"@type":"Person","name":"Abdeldjalil Fortas","description":"A part-time Karantika lover","url":"https://github.com/fcmam5","image":"https://github.com/fcmam5.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://fcmam5.me/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Abdeldjalil Fortas&#39; notepad RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Abdeldjalil Fortas&#39; notepad Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6WM7E899MF"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-6WM7E899MF",{anonymize_ip:!0})</script>


<link rel="alternate" type="application/rss+xml" href="/snippets/rss.xml" title="Abdeldjalil Fortas&#39; notepad RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/snippets/atom.xml" title="Abdeldjalil Fortas&#39; notepad Atom Feed">
<link rel="alternate" type="application/rss+xml" href="/dz-blog/rss.xml" title="Abdeldjalil Fortas&#39; notepad RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/dz-blog/atom.xml" title="Abdeldjalil Fortas&#39; notepad Atom Feed"><link rel="stylesheet" href="/assets/css/styles.74adf7bd.css">
<script src="/assets/js/runtime~main.0d694d70.js" defer="defer"></script>
<script src="/assets/js/main.918af5d2.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_mbPH" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/apple-touch-icon.png" alt="My Site Logo" class="themedComponent_uAN0 themedComponent--light_SXb1"><img src="/img/apple-touch-icon.png" alt="My Site Logo" class="themedComponent_uAN0 themedComponent--dark_SjJw"></div><b class="navbar__title text--truncate">Fcmam5</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/snippets">Snippets</a><a class="navbar__item navbar__link" href="/dz-blog">&lt;DZ /&gt;</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/fcmam5" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_gJu7"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_rsod colorModeToggle_u7Gg"><button class="clean-btn toggleButton_QS8D toggleButtonDisabled_slaE" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_1PNb"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon__WzC"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_cX17"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_NfWm"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_gBQ4 thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_sFqA margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rIyo">2024</h3><ul class="sidebarItemList_GrSo clean-list"><li class="sidebarItem_rPLS"><a class="sidebarItemLink_XgkD" href="/blog/breaking-cors-by-fixing-it">Breaking CORS by &quot;trying to fix it&quot;</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rIyo">2023</h3><ul class="sidebarItemList_GrSo clean-list"><li class="sidebarItem_rPLS"><a class="sidebarItemLink_XgkD" href="/blog/why-you-should-kick-idle-users-out-of-your-website">Why you should kick idle users out of your website</a></li><li class="sidebarItem_rPLS"><a aria-current="page" class="sidebarItemLink_XgkD sidebarItemLinkActive_j5og" href="/blog/avoiding-nestjs-performance-bottlenecks">Avoiding NestJS performance bottlenecks</a></li><li class="sidebarItem_rPLS"><a class="sidebarItemLink_XgkD" href="/blog/ctf-as-a-developer-pt-1-template-engines-ssti">CTF as a developer (Pt. 1): Template engines &amp; SSTI</a></li><li class="sidebarItem_rPLS"><a class="sidebarItemLink_XgkD" href="/blog/trying-to-become-a-better-developer-by-learning-more-about-aviation">Trying to become a better developer by learning more about aviation</a></li></ul></div></nav></aside><main class="col col--7"><article><header><h1 class="title_baV2">Avoiding NestJS performance bottlenecks</h1><div class="container_NGf5 margin-vert--md"><time datetime="2023-09-23T00:00:00.000Z">September 23, 2023</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Qrfb"><div class="avatar margin-bottom--sm"><a href="https://github.com/fcmam5" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_AJIl" src="https://github.com/fcmam5.png" alt="Abdeldjalil Fortas"></a><div class="avatar__intro authorDetails_sZxj"><div class="avatar__name"><a href="https://github.com/fcmam5" target="_blank" rel="noopener noreferrer"><span class="authorName_R1BY">Abdeldjalil Fortas</span></a></div><small class="authorTitle_7Fhs" title="A part-time Karantika lover">A part-time Karantika lover</small><div class="authorSocials_d2pO"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>I have been using <a href="https://nestjs.com/" target="_blank" rel="noopener noreferrer">NestJS</a> for quite some time now. And as every JavaScript developer, I like to complain about it but I still love it, and I still have it as one of my go-to whenever I want to create any Node application.</p>
<p>NestJS helps you enjoy a good developer experience, especially if you are a proponent of OOP, and/or you are working with people who are used to other frameworks like Angular, or coming from a Java/Spring background.</p>
<p>NestJS implements <a href="https://github.com/nestjs/nest/blob/master/packages/common/decorators/core/injectable.decorator.ts" target="_blank" rel="noopener noreferrer">its dependency injection framework</a>, which allows an easy abstraction of dependencies making code easier to maintain, test, and swap third-party libraries.</p>
<p>With its powerful <a href="https://docs.nestjs.com/cli/overview" target="_blank" rel="noopener noreferrer">CLI</a>, NestJS bootstraps applications in record time, it also comes with pre-configured modules, or installable plugins making it pleasant to work with and a powerful beginners-friendly tool.</p>
<div class="theme-admonition theme-admonition-note admonition_oBR_ alert alert--secondary"><div class="admonitionHeading_BquS"><span class="admonitionIcon_bL4W"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_TttM"><p>I published this article previously on Medium: <a href="https://medium.com/@Fcmam5/avoiding-nestjs-performance-bottlenecks-78fa2bc66372" target="_blank" rel="noopener noreferrer">Avoiding NestJS performance bottlenecks</a></p></div></div>
<p>However, “<a href="https://youtu.be/377VhCOtoDA" target="_blank" rel="noopener noreferrer">With great power comes great responsibility</a>” and NestJS is not an exception to Uncle Ben’s quote.</p>
<p>Nest’s “fancy” configuration is sometimes more fun to develop, but it sometimes causes performance bottlenecks. Especially when we start customizing things out of the framework’s way of doing them, then things can get ugly easily.</p>
<p>Here are some of the things I learned over the last few years:</p>
<h2 class="anchor anchorWithStickyNavbar_hDRy" id="carefully-upgrade-to-newer-nestjs-and-nodejs-versions">Carefully upgrade to newer NestJS and Node.js versions<a href="#carefully-upgrade-to-newer-nestjs-and-nodejs-versions" class="hash-link" aria-label="Direct link to Carefully upgrade to newer NestJS and Node.js versions" title="Direct link to Carefully upgrade to newer NestJS and Node.js versions">​</a></h2>
<p>The Node.js community is active and continuously working on improving the ecosystem, and now thanks to <a href="https://github.com/nodejs/performance" target="_blank" rel="noopener noreferrer">a performance-focused team</a> our beloved JavaScript runtime is getting faster and more performant.</p>
<p>One of the performance wins I could achieve was by simply bumping my runtime version from 14 to 16 and then to 18 while making little to no changes to my NestJS microservices code.</p>
<p>Similarly, the NestJS became more stable. With <a href="https://github.com/nestjs/docs.nestjs.com/blob/00a3eaa6ee48d072427805efba7b3d7c19cc74fd/content/migration.md" target="_blank" rel="noopener noreferrer">few</a> breaking changes from v8.x to 10.x, I feel more comfortable keeping up with new major releases to benefit from the new performance improvements, CVE patches, and bug fixes.</p>
<h2 class="anchor anchorWithStickyNavbar_hDRy" id="the-logger">The logger<a href="#the-logger" class="hash-link" aria-label="Direct link to The logger" title="Direct link to The logger">​</a></h2>
<p>NestJS comes with a default <a href="https://github.com/nestjs/nest/blob/67951ff2e9b7f4803856ab8169e23350e49d7dfc/packages/common/services/console-logger.service.ts#L221" target="_blank" rel="noopener noreferrer">logger which is used by default <code>process.stdout.write</code></a>.</p>
<p><code>process.stdout</code> and <code>process.stderr</code> is not advised to be used in logging as it may behave synchronously and block the event loop, as the <a href="https://nodejs.org/api/process.html#a-note-on-process-io" target="_blank" rel="noopener noreferrer">Node.js documentation states</a>:</p>
<blockquote>
<p><strong>Warning:</strong> <em>Synchronous writes block the event loop until the write has completed. This can be near instantaneous in the case of output to a file, but under high system load, pipes that are not being read at the receiving end, or with slow terminals or file systems, it’s possible for the event loop to be blocked often enough and long enough to have severe negative performance impacts. This may not be a problem when writing to an interactive terminal session, <strong>but consider this particularly careful when doing production logging to the process output streams</strong>.</em></p>
</blockquote>
<p>Gladly, the logger <a href="https://docs.nestjs.com/techniques/logger#use-external-logger" target="_blank" rel="noopener noreferrer">can be easily customized</a> and replaced by dedicated logging libraries such as <a href="https://github.com/iamolegga/nestjs-pino" target="_blank" rel="noopener noreferrer">nestjs-pino</a> and <a href="https://github.com/gremo/nest-winston" target="_blank" rel="noopener noreferrer">nest-winston</a> which also offer more flexibility and better performance. NestJS documentation covers that well.</p>
<p>However, even when using custom loggers there are some things to consider.</p>
<h3 class="anchor anchorWithStickyNavbar_hDRy" id="startup-logger">Startup logger<a href="#startup-logger" class="hash-link" aria-label="Direct link to Startup logger" title="Direct link to Startup logger">​</a></h3>
<p>Even if you use a custom logging library, you’d still have the first few logs printed in Nest’s standard standard form. As NestJS will start streaming application start logs before the logger is attached, that not only may lose crucial framework setup logs from being hidden from logging dashboards but also impact the startup time with few MS.</p>
<p>For example, I usually go for <a href="https://github.com/pinojs/pino" target="_blank" rel="noopener noreferrer">Pino</a> (with <a href="https://github.com/iamolegga/nestjs-pino" target="_blank" rel="noopener noreferrer">nestjs-pino</a>) as my logging library, my <code>main.ts</code> have:</p>
<div class="language-typescript codeBlockContainer_HoUO theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_fLNQ"><pre tabindex="0" class="prism-code language-typescript codeBlock_OwT2 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_CaTV"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> NestFactory </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;@nestjs/core&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> AppModule </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;./app.module&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Logger </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;nestjs-pino&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bootstrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> NestFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AppModule</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">useLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Logger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">listen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">bootstrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_ry9d"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_hlAx" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_e2oV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Kvv3"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This produces a mixed log format as the following:</p>
<div class="language-json codeBlockContainer_HoUO theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_fLNQ"><pre tabindex="0" class="prism-code language-json codeBlock_OwT2 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_CaTV"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Nest</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">89914</span><span class="token plain">  - </span><span class="token number" style="color:#36acaa">09</span><span class="token plain">/</span><span class="token number" style="color:#36acaa">16</span><span class="token plain">/</span><span class="token number" style="color:#36acaa">2023</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">25</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">41</span><span class="token plain"> AM     LOG </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NestFactory</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Starting Nest application...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Nest</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">89914</span><span class="token plain">  - </span><span class="token number" style="color:#36acaa">09</span><span class="token plain">/</span><span class="token number" style="color:#36acaa">16</span><span class="token plain">/</span><span class="token number" style="color:#36acaa">2023</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">25</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">41</span><span class="token plain"> AM     LOG </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">InstanceLoader</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> AppModule dependencies initialized +16ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Nest</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">89914</span><span class="token plain">  - </span><span class="token number" style="color:#36acaa">09</span><span class="token plain">/</span><span class="token number" style="color:#36acaa">16</span><span class="token plain">/</span><span class="token number" style="color:#36acaa">2023</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">25</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">41</span><span class="token plain"> AM     LOG </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">InstanceLoader</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> LoggerModule dependencies initialized +0ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;level&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;time&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1694823941975</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;pid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">89914</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;hostname&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Fcmam5&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;context&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;RoutesResolver&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;msg&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;AppController {/}:&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;level&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;time&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1694823941978</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;pid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">89914</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;hostname&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Fcmam5&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;context&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;RouterExplorer&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;msg&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Mapped {/, GET} route&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;level&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;time&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1694823941980</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;pid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">89914</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;hostname&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Fcmam5&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;context&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;NestApplication&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;msg&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Nest application successfully started&quot;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_ry9d"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_hlAx" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_e2oV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Kvv3"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The fix would be just buffering logs by setting <code>bufferLogs</code> to <code>true</code>:</p>
<div class="language-typescript codeBlockContainer_HoUO theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_fLNQ"><pre tabindex="0" class="prism-code language-typescript codeBlock_OwT2 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_CaTV"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> NestFactory </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;@nestjs/core&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> AppModule </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;./app.module&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Logger </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;nestjs-pino&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bootstrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> NestFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AppModule</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> bufferLogs</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">useLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Logger</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">listen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">bootstrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_ry9d"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_hlAx" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_e2oV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Kvv3"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This makes sure all logs will be buffered until the custom logger is attached and then logged in its format (<code>nestjs-pino</code> in this case), so I would have something like:</p>
<div class="language-json codeBlockContainer_HoUO theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_fLNQ"><pre tabindex="0" class="prism-code language-json codeBlock_OwT2 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_CaTV"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;level&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;time&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1694858121769</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;pid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">97585</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;hostname&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Fcmam5&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;context&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;NestFactory&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;msg&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Starting Nest application...&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;level&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;time&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1694858121770</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;pid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">97585</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;hostname&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Fcmam5&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;context&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;InstanceLoader&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;msg&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;AppModule dependencies initialized&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;level&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;time&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1694858121770</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;pid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">97585</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;hostname&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Fcmam5&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;context&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;InstanceLoader&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;msg&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;LoggerModule dependencies initialized&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;level&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;time&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1694858121770</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;pid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">97585</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;hostname&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Fcmam5&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;context&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;RoutesResolver&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;msg&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;AppController {/}:&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;level&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;time&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1694858121770</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;pid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">97585</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;hostname&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Fcmam5&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;context&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;RouterExplorer&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;msg&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Mapped {/, GET} route&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;level&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;time&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1694858121770</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;pid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">97585</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;hostname&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Fcmam5&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;context&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;NestApplication&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;msg&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Nest application successfully started&quot;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_ry9d"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_hlAx" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_e2oV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Kvv3"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note that for standalone applications <a href="https://github.com/iamolegga/nestjs-pino#logger-substitution" target="_blank" rel="noopener noreferrer">you may need to flush log buffers manually</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_hDRy" id="injection-scopes">Injection scopes<a href="#injection-scopes" class="hash-link" aria-label="Direct link to Injection scopes" title="Direct link to Injection scopes">​</a></h2>
<p>We had a use case where we wanted to inject a <a href="https://microsoft.github.io/code-with-engineering-playbook/observability/correlation-id/" target="_blank" rel="noopener noreferrer">correlation ID</a> into our logs to keep track of what was happening in our application for a particular request.</p>
<p>The naïve approach I was about to use, was to implement a <a href="https://docs.nestjs.com/fundamentals/injection-scopes#request-provider" target="_blank" rel="noopener noreferrer">request-scoped</a> instance of the logger, something like:</p>
<div class="language-typescript codeBlockContainer_HoUO theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_fLNQ"><pre tabindex="0" class="prism-code language-typescript codeBlock_OwT2 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_CaTV"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Injectable</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Scope</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Inject</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;@nestjs/common&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator at operator" style="color:#393A34">@</span><span class="token decorator function" style="color:#d73a49">Injectable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> scope</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Scope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">REQUEST</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">SomeBrokenLoggingService</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">callCustomLoggingLib</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">reqId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getCorrelationID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_ry9d"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_hlAx" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_e2oV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_Kvv3"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then I learned how bad that call was, I overlooked the fact that this approach means that I will be instantiating a new instance <code>SomeBrokenLoggingService</code> for each request, that would impact my application performance (see: <a href="https://docs.nestjs.com/fundamentals/injection-scopes#performance" target="_blank" rel="noopener noreferrer">injection-scopes#performance</a>).</p>
<p>The learnings I got from that were:</p>
<ol>
<li>To use a well-maintained library to do that for me.</li>
<li>To be more careful with Injection scopes.</li>
<li>Consider using <a href="https://docs.nestjs.com/recipes/async-local-storage" target="_blank" rel="noopener noreferrer">async local storage</a> for some use cases (recently added, thanks NestJS community!).</li>
</ol>
<p>For example, <a href="https://github.com/iamolegga/nestjs-pino#faq" target="_blank" rel="noopener noreferrer">nestjs-pino</a> uses <a href="https://nodejs.org/api/async_context.html#async_context_class_asynclocalstorage" target="_blank" rel="noopener noreferrer">AsyncLocalStorage</a> (previously relied on <a href="https://www.npmjs.com/package/cls-hooked" target="_blank" rel="noopener noreferrer">cls-hooked</a> package).</p>
<h2 class="anchor anchorWithStickyNavbar_hDRy" id="use-fastify">Use Fastify<a href="#use-fastify" class="hash-link" aria-label="Direct link to Use Fastify" title="Direct link to Use Fastify">​</a></h2>
<p>Made by Node.js maintainers who worked on performance, Fastify <a href="https://fastify.dev/benchmarks" target="_blank" rel="noopener noreferrer">has proven its performance</a> and it’s making its way to compete with Express to be the most popular Node.js framework.</p>
<p>NestJS comes by default with <a href="https://www.npmjs.com/package/@nestjs/platform-express" target="_blank" rel="noopener noreferrer">Express platform</a>, but it can be easily switched to Fastify, and the documentation did a great job explaining it on the <a href="https://docs.nestjs.com/techniques/performance#performance-fastify" target="_blank" rel="noopener noreferrer">“Performance (Fastify)” page</a>.</p>
<p>The switch from Express to Fastify can be done easily if your codebase is not relying on Express-specific code (as it should be if done à la NestJS), you may only change req/res types from Fastify’s Request and FastifyReply interfaces and probably have to replace the usage of some packages like helmet <a href="https://docs.nestjs.com/security/helmet#use-with-fastify" target="_blank" rel="noopener noreferrer">to use helmet/fastify</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_hDRy" id="other-things-to-consider">Other things to consider<a href="#other-things-to-consider" class="hash-link" aria-label="Direct link to Other things to consider" title="Direct link to Other things to consider">​</a></h2>
<p>Rule #0: <strong>MEASURE!</strong></p>
<p>Before blaming the framework, we should make sure that our code is performant, that our usage of third-party components is efficient, and that our database queries are efficient.</p>
<p>Then we may start looking into other framework-related micro-optimizations:</p>
<ul>
<li>Global pipes, middlewares, guards, and filters might not be always a good idea.
They sometimes run unnecessary code for endpoints that don’t need their transformations.</li>
<li>Use lazy loading if it’s relevant to your use case.
Lazy loading defers module registration by loading them asynchronously to decrease application startup time (which might make sense in a serverless environment).</li>
<li>If you are using the config module, and accessing environment variables using <code>process.env</code> might be slow, cashing can be a solution, see: <a href="https://docs.nestjs.com/techniques/configuration#cache-environment-variables" target="_blank" rel="noopener noreferrer">Cache environment variables</a>.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_hDRy" id="final-thoughts">Final thoughts<a href="#final-thoughts" class="hash-link" aria-label="Direct link to Final thoughts" title="Direct link to Final thoughts">​</a></h2>
<p>It might be unfair to compare NestJS to Express, Hapi, Koa, or Fastify. We will find out that it’s either slow, has a bigger memory footprint, or uses more CPU. That makes sense.</p>
<p>NestJS takes care of a lot of things by default to offer a good and <em>“flexible”</em> developer experience with its built-in libraries and configurations making <a href="https://stackoverflow.com/a/48226084/5078746" target="_blank" rel="noopener noreferrer">micro-sacrifices of performance</a>, which can be accepted.</p>
<p><a href="https://youtu.be/tKbV6BpH-C8" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" alt="CodeAesthetic: Premature optimization" src="/assets/images/premature-optimization-dbb1c414c2c337dae45a02b1b6d4463c.png" width="1400" height="802" class="img_hjxC"></a></p>
<p>Premature optimization is evil, and if one really can spot performance decrease; Analysis must be done first, by applying the <a href="https://en.wikipedia.org/wiki/Pareto_principle" target="_blank" rel="noopener noreferrer">20-80% rule</a>, we may figure out that most performance hits are not directly related to the framework, but our code, our logic and the way we interact with third-parties.</p>
<p>We should first find the bottlenecks that are decreasing performance the most, fix them, monitor and then consider if it makes sense to push for more micro-optimizations.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_oPMp padding--none margin-left--sm"><li class="tag_dWG9"><a class="tag_c8SB tagRegular_UGa9" href="/blog/tags/backend">backend</a></li><li class="tag_dWG9"><a class="tag_c8SB tagRegular_UGa9" href="/blog/tags/nestjs">nestjs</a></li><li class="tag_dWG9"><a class="tag_c8SB tagRegular_UGa9" href="/blog/tags/development">development</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/Fcmam5/fcmam5.github.io/tree/master/portfolio/blog/2023-09-23-avoiding-nestjs-perf-bottlenecks/index.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_vgs4" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_l9Jf"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/why-you-should-kick-idle-users-out-of-your-website"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Why you should kick idle users out of your website</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/ctf-as-a-developer-pt-1-template-engines-ssti"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">CTF as a developer (Pt. 1): Template engines &amp; SSTI</div></a></nav></main><div class="col col--2"><div class="tableOfContents_f6Mq thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#carefully-upgrade-to-newer-nestjs-and-nodejs-versions" class="table-of-contents__link toc-highlight">Carefully upgrade to newer NestJS and Node.js versions</a></li><li><a href="#the-logger" class="table-of-contents__link toc-highlight">The logger</a><ul><li><a href="#startup-logger" class="table-of-contents__link toc-highlight">Startup logger</a></li></ul></li><li><a href="#injection-scopes" class="table-of-contents__link toc-highlight">Injection scopes</a></li><li><a href="#use-fastify" class="table-of-contents__link toc-highlight">Use Fastify</a></li><li><a href="#other-things-to-consider" class="table-of-contents__link toc-highlight">Other things to consider</a></li><li><a href="#final-thoughts" class="table-of-contents__link toc-highlight">Final thoughts</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">About me</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/snippets">Snippets</a></li><li class="footer__item"><a class="footer__link-item" href="/contributions">Contributions</a></li><li class="footer__item"><a class="footer__link-item" href="/libraries">Libraries</a></li><li class="footer__item"><a href="https://www.credly.com/users/fcmam5" target="_blank" rel="noopener noreferrer" class="footer__link-item">Creedly<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_gJu7"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Let&#x27;s connect</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/Fcmam5" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_gJu7"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://stackoverflow.com/users/5078746/fcmam5" target="_blank" rel="noopener noreferrer" class="footer__link-item">StackOverflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_gJu7"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://linkedin.com/in/fcmam5" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_gJu7"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/Fcmam5" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_gJu7"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://medium.com/@Fcmam5" target="_blank" rel="noopener noreferrer" class="footer__link-item">Medium<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_gJu7"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Abdeldjalil Fortas. Built with Docusaurus (while drinking green tea this time).</div></div></div></footer></div>
</body>
</html>
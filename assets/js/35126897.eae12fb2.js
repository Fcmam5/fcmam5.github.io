"use strict";(self.webpackChunkportfolio=self.webpackChunkportfolio||[]).push([[5104],{4854:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var i=t(565),a=t(6070),s=t(989);const r={description:"Learning about cybersecurity as a developer by playing CTF (Part1: Template engines and SSTI)",slug:"ctf-as-a-developer-pt-1-template-engines-ssti",authors:["fcmam5"],tags:["backend","cybersecurity","frontend"]},o="CTF as a developer (Pt. 1): Template engines & SSTI",l={authorsImageUrls:[void 0]},c=[{value:"What are template engines?",id:"what-are-template-engines",level:2},{value:"Server-side template injection (SSTI) vulnerabilities",id:"server-side-template-injection-ssti-vulnerabilities",level:2},{value:"Why should I even care?",id:"why-should-i-even-care",level:2},{value:"Remediation",id:"remediation",level:2},{value:"NEVER trust client-side validation",id:"never-trust-client-side-validation",level:3},{value:"Use well-maintained and known template engines",id:"use-well-maintained-and-known-template-engines",level:3},{value:"Read the documentation",id:"read-the-documentation",level:3},{value:"Sanitizing inputs",id:"sanitizing-inputs",level:3},{value:"Don\u2019t guide attackers",id:"dont-guide-attackers",level:3},{value:"Do not trust your client-facing renderer application",id:"do-not-trust-your-client-facing-renderer-application",level:3},{value:"Final thoughts",id:"final-thoughts",level:2},{value:"Resources",id:"resources",level:3}];function d(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"Being a software developer is a responsibility, it\u2019s a job where we provide secure and stable services and infrastructure to users who trust us (or trust regulations that ensure we are trustworthy)."}),"\n",(0,a.jsx)(n.p,{children:"To learn more about cybersecurity principles, and why some \u201cbest practices\u201d matter, I decided to play some CTF challenges instead of only relying on reading articles and scrolling into OWASP top 10\u2019s documentation."}),"\n",(0,a.jsxs)(n.p,{children:["My beginning was with HackTheBox. For some reason, some of the challenges I did had ",(0,a.jsx)(n.a,{href:"https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/18-Testing_for_Server-side_Template_Injection",children:"Server-side Template Injection (SSTI)"})," vulnerabilities which I\u2019m starting this blog series with."]}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"If you are a security professional or an experienced programmer this article might not bring you anything new, feel free to stop reading now, but I would appreciate your inputs, corrections and guidance!"}),"\n"]}),"\n",(0,a.jsx)(n.admonition,{type:"note",children:(0,a.jsxs)(n.p,{children:["I published this article previously on Medium: ",(0,a.jsx)(n.a,{href:"https://medium.com/@Fcmam5/ctf-as-a-developer-pt-1-template-engines-ssti-b03c59e2c095",children:"CTF as a developer (Pt. 1): Template engines & SSTI"})]})}),"\n",(0,a.jsx)(n.h2,{id:"what-are-template-engines",children:"What are template engines?"}),"\n",(0,a.jsx)(n.p,{children:"Template engines are tools that facilitate rendering content for web applications by injecting data into static templates."}),"\n",(0,a.jsxs)(n.p,{children:["Template engines like ",(0,a.jsx)(n.a,{href:"https://github.com/pallets/jinja",children:"Jinja"}),", ",(0,a.jsx)(n.a,{href:"https://handlebarsjs.com/",children:"Handlebars"}),", ",(0,a.jsx)(n.a,{href:"https://ejs.co/",children:"EJS"}),", or PHP\u2019s ",(0,a.jsx)(n.a,{href:"https://twig.symfony.com/",children:"Twig"})," provide more features for developers to add more logic (with variables, functions, loops, etc.) to templates which makes development and maintenance easier."]}),"\n",(0,a.jsx)(n.h2,{id:"server-side-template-injection-ssti-vulnerabilities",children:"Server-side template injection (SSTI) vulnerabilities"}),"\n",(0,a.jsxs)(n.p,{children:["Consider this simple, and ugly app that greets the user every time they visit our ",(0,a.jsx)(n.code,{children:"/greeting/<name>"})," route:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"from flask import Flask, render_template_string\nfrom random import choice\n\napp = Flask(__name__)\n\n@app.route(\"/greeting/<name>\")\ndef greeting(name):\n    greeting = choice([\"Hi\", \"Hello\", \"Welcome\"])\n    template = '''\n    <!DOCTYPE html>\n    <html lang=\"en\">\n    <head>\n        <meta charset=\"UTF-8\" />\n        <title>Greeting</title>\n    </head>\n    <body>\n        <h1>''' + greeting + ' ' + name + '''!</h1>\n    </body>\n    </html>'''\n    return render_template_string(template)\n\nif __name__ == '__main__':\n    app.run(debug=True,port=8080)\n"})}),"\n",(0,a.jsxs)(n.p,{children:["For example, ",(0,a.jsx)(n.code,{children:"GET /greeting/Alice"})," would show:"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Example page",src:t(2311).A+"",width:"720",height:"260"})}),"\n",(0,a.jsxs)(n.p,{children:["Now that we (or attackers) know that we are passing a user-provided variable to the template, we can experiment by passing a Jinja2 expression ",(0,a.jsx)(n.code,{children:"{{ 2 + 2 }}"}),". In my case that would show:"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Template injection example",src:t(3836).A+"",width:"720",height:"183"})}),"\n",(0,a.jsxs)(n.p,{children:["This means that the expression was evaluated as a Jinja template, which means that attackers can inject Python code that can do anything, for example running an ",(0,a.jsx)(n.code,{children:"ls -R"})," on the application server\u2019s shell with an expression like the following:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"{{request.application.__globals__.__builtins__.__import__('os').popen('ls -R').read()}}\n"})}),"\n",(0,a.jsx)(n.p,{children:"Which will show:"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"ls -R",src:t(5755).A+"",width:"1264",height:"326"})}),"\n",(0,a.jsx)(n.p,{children:"Attackers can be creative from here, they can run any command to upload/download more malicious scripts to our application servers which will give them more access and make things far easier for them."}),"\n",(0,a.jsx)(n.p,{children:"The risks of such an attack are high, especially since even skiddies may use free scripts and tools that are available online to scan and exploit websites. The magical command:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"request.application.__globals__.__builtins__.__import__('os').popen('ls -R').read()\n"})}),"\n",(0,a.jsx)(n.p,{children:"Can be found in serval blogs online along with other tricks for more powerful exploits. That means that anyone can exploit it, so please let\u2019s take it seriously."}),"\n",(0,a.jsxs)(n.p,{children:["Security professionals and threat actors also rely on tools (such as ",(0,a.jsx)(n.a,{href:"https://github.com/epinna/tplmap",children:"tplmap"}),") to find and exploit real-world applications, which makes SSTI vulnerabilities critical to solve as they might be easy to find and exploit."]}),"\n",(0,a.jsx)(n.h2,{id:"why-should-i-even-care",children:"Why should I even care?"}),"\n",(0,a.jsx)(n.p,{children:"Even if you are building a small side-project, you really have to not neglect basic security aspects."}),"\n",(0,a.jsx)(n.p,{children:"Threat actors may use your applications\u2019 servers as nodes in their botnets, or use them as proxies when performing attacks on more critical targets.\nOr they would make your application server into a crypto-miner, or a platform to run their CPU-expensive applications."}),"\n",(0,a.jsx)(n.p,{children:"You really don\u2019t want to have unnecessary cost and legal implications for just neglecting good practices."}),"\n",(0,a.jsx)(n.h2,{id:"remediation",children:"Remediation"}),"\n",(0,a.jsx)(n.p,{children:"There are plenty of articles online by security professionals who\u2019d tell you how to protect yourself from SSTI and this one would only give typical recommendations:"}),"\n",(0,a.jsx)(n.h3,{id:"never-trust-client-side-validation",children:"NEVER trust client-side validation"}),"\n",(0,a.jsx)(n.p,{children:"Client-side validation is for real application users, it offers guidance and early feedback if they insert any invalid input. It can never block any attack as it can easily bypassed with different techniques."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Programmerhummor: Client-side validation",src:t(9744).A+"",width:"480",height:"270"})}),"\n",(0,a.jsx)(n.p,{children:"As trivial as it sounds to any experienced developer or any security professional reading this, we still can find unprotected endpoints."}),"\n",(0,a.jsx)(n.p,{children:"The absence of server-side validation might happen if applications are built by inexperienced and junior developers (WRITING about it, since I\u2019m guilty of this), or it may also happen correctly if front-end and backend developers are not aligned which would produce inconsistencies in validation rules."}),"\n",(0,a.jsx)(n.h3,{id:"use-well-maintained-and-known-template-engines",children:"Use well-maintained and known template engines"}),"\n",(0,a.jsxs)(n.p,{children:["Sometimes ",(0,a.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Linus%27s_law",children:"Linus\u2019s law"})," applies; given enough eyeballs looking at a particular code, bugs and security issues will be discovered."]}),"\n",(0,a.jsx)(n.p,{children:"Template engines like Jinja, EJS, or Twig are maintained by many smart developers who try to maintain them while keeping them safe."}),"\n",(0,a.jsx)(n.p,{children:"If you are working on an application that would go to production, consider using stable and well-maintained libraries and keeping them up-to-date as they will always provide patches to any possible CVEs."}),"\n",(0,a.jsx)(n.h3,{id:"read-the-documentation",children:"Read the documentation"}),"\n",(0,a.jsx)(n.p,{children:"Good libraries are well-documented by the people who built them, and who are using them. You should always rely on the official documentation and not only blog articles and copying around code snippets from StackOverflow or some AI-generated tools."}),"\n",(0,a.jsx)(n.p,{children:"Sometimes, defaults are evil, and sometimes they are \u201cthe safest\u201d option. Only a wise developer can understand how things work and how they should be used."}),"\n",(0,a.jsxs)(n.p,{children:["For example, my previous demo wouldn\u2019t work if I just used ",(0,a.jsx)(n.a,{href:"https://flask.palletsprojects.com/en/2.3.x/api/#flask.render_template_string",children:"flask.render_template_string"})," correctly by passing my variables as parameters and letting it synthesize the rendered expression"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'def greeting(name):\n    greeting = choice(["Hi", "Hello", "Welcome"])\n    template = \'\'\'\n    <!DOCTYPE html>\n    <html lang="en">\n    <head>\n        <meta charset="UTF-8" />\n        <title>Greeting</title>\n    </head>\n    <body>\n        <h1> {{ greeting }} {{ name }}!</h1>\n    </body>\n    </html>\'\'\'\n    return render_template_string(template, greeting=greeting, name=name)\n'})}),"\n",(0,a.jsx)(n.p,{children:"Then the passed value will be synthesized, and rendered as a string"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Sanitized output",src:t(4323).A+"",width:"1314",height:"294"})}),"\n",(0,a.jsx)(n.h3,{id:"sanitizing-inputs",children:"Sanitizing inputs"}),"\n",(0,a.jsx)(n.p,{children:"Not trusting any user-provided input by validating and sanitizing is a general rule when building applications."}),"\n",(0,a.jsx)(n.p,{children:"One other piece of advice is to use libraries, and not overengineer another sanitization and/or validation library unless you have a very specific use case and enough resources to build it. It is hard to list and cover all possible scenarios and tricks by yourself."}),"\n",(0,a.jsx)(n.h3,{id:"dont-guide-attackers",children:"Don\u2019t guide attackers"}),"\n",(0,a.jsx)(n.p,{children:"Unless you reveal your technology stack or maintain an open-source application, attackers will scan your application to find which technology you are using before they try to exploit it."}),"\n",(0,a.jsx)(n.p,{children:"There are plenty of template engines out there, and only by finding which technology is used in rendering them, attackers will save a lot of time that we would take in scanning and brute-forcing."}),"\n",(0,a.jsx)(n.p,{children:"To hide which backend technology is used in your backend, or at least your front-end rendering service, we can follow these recommendations:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Make sure to not log any debug messages on the front-end and disable debug mode in your framework."}),"\n",(0,a.jsx)(n.li,{children:"Use non-standard framework error pages/messages, consider catching errors and returning your custom error pages. You can make them static (not rendering any variable or expression) unless you can really justify it."}),"\n",(0,a.jsxs)(n.li,{children:["Remove ",(0,a.jsx)(n.code,{children:"X-Powered-By"}),", ",(0,a.jsx)(n.code,{children:"Server"}),", and any other HTTP headers that would expose your application server (e.g. ",(0,a.jsx)(n.code,{children:"X-AspNet-Version"}),"), or just a library like ",(0,a.jsx)(n.a,{href:"https://helmetjs.github.io/",children:"Helmet"})," for Node.js."]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"do-not-trust-your-client-facing-renderer-application",children:"Do not trust your client-facing renderer application"}),"\n",(0,a.jsx)(n.p,{children:"If you are working on a critical application, you might be already applying a zero-trust system which would also affect your application deployment and architecture."}),"\n",(0,a.jsx)(n.p,{children:"In case your renderer application is containerized, you can consider using distroless images which is a minimalistic setup for your application (removing shell and its utilities) which would limit what can be done if someone took over your application."}),"\n",(0,a.jsx)(n.p,{children:"Running application processes as a non-root user, and having its filesystem set to read-only in addition to limiting its network access to internal infrastructure."}),"\n",(0,a.jsx)(n.p,{children:"That may protect the infrastructure from having a backdoor in the renderer."}),"\n",(0,a.jsx)(n.h2,{id:"final-thoughts",children:"Final thoughts"}),"\n",(0,a.jsx)(n.p,{children:"We humans are the most vulnerable piece of any complex software system. We can introduce serious security flaws by being lazy or not taking things seriously or by sacrificing best practices for the sake of speed of delivery."}),"\n",(0,a.jsx)(n.p,{children:"SSTI is an example of vulnerabilities that might be easy to avoid by just educating ourselves that it\u2019s a risk, by spending some time adapting well-maintained templating engines and keeping them up-to-date or at least updating them when security patches are released."}),"\n",(0,a.jsx)(n.p,{children:"Adapting templating engines should be done with best practices and security by default. Then developers should have a good code review culture to make sure that libraries are used and configured as they should be."}),"\n",(0,a.jsx)(n.p,{children:"If you are reading this blog and you are also one of us, who only learn by doing and by breaking things, have a look at these challenges from HackThe box:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://app.hackthebox.com/challenges/395",children:"https://app.hackthebox.com/challenges/395"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://app.hackthebox.com/challenges/152",children:"https://app.hackthebox.com/challenges/152"})}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Or, you can use these applications that are explicitly made to be vulnerable:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://owasp.org/www-project-juice-shop/",children:"https://owasp.org/www-project-juice-shop/"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://github.com/OWASP/NodeGoat",children:"https://github.com/OWASP/NodeGoat"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://github.com/appsecco/dvna",children:"https://github.com/appsecco/dvna"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://github.com/CTFd/CTFd",children:"https://github.com/CTFd/CTFd"})}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["Or this lab from PortSwigger\u2019s ",(0,a.jsx)(n.a,{href:"https://portswigger.net/web-security",children:"Web Security Academy"}),":"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.a,{href:"https://portswigger.net/web-security/server-side-template-injection/exploiting",children:"https://portswigger.net/web-security/server-side-template-injection/exploiting"})}),"\n",(0,a.jsx)(n.h3,{id:"resources",children:"Resources"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/18-Testing_for_Server-side_Template_Injection",children:"https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/18-Testing_for_Server-side_Template_Injection"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://www.vaadata.com/blog/server-side-template-injection-vulnerability-what-it-is-how-to-prevent-it/",children:"https://www.vaadata.com/blog/server-side-template-injection-vulnerability-what-it-is-how-to-prevent-it/"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://portswigger.net/research/server-side-template-injection",children:"https://portswigger.net/research/server-side-template-injection"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},9744:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/client-side-validation-a9874f37922099edca00ca12cf2adefe.png"},5755:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/ls-r-injection-d7641ae71a43a620f8321fdc4e8d0ed0.png"},4323:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/sanized-output-9a7d0b45430fd205210b3ef5c59baa7a.png"},2311:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/tpl-1-9c68e0c2241aaf03e3a954ab3f91d453.png"},3836:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/tpl-2-0d98ae8f0248cec44074fab07fb3b902.png"},989:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>o});var i=t(758);const a={},s=i.createContext(a);function r(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),i.createElement(s.Provider,{value:n},e.children)}},565:e=>{e.exports=JSON.parse('{"permalink":"/blog/ctf-as-a-developer-pt-1-template-engines-ssti","editUrl":"https://github.com/Fcmam5/fcmam5.github.io/tree/master/portfolio/blog/2023-09-07-ctf-as-dev-1-ssti/index.md","source":"@site/blog/2023-09-07-ctf-as-dev-1-ssti/index.md","title":"CTF as a developer (Pt. 1): Template engines & SSTI","description":"Learning about cybersecurity as a developer by playing CTF (Part1: Template engines and SSTI)","date":"2023-09-07T00:00:00.000Z","tags":[{"inline":true,"label":"backend","permalink":"/blog/tags/backend"},{"inline":true,"label":"cybersecurity","permalink":"/blog/tags/cybersecurity"},{"inline":true,"label":"frontend","permalink":"/blog/tags/frontend"}],"readingTime":7.36,"hasTruncateMarker":true,"authors":[{"name":"Abdeldjalil Fortas","title":"A part-time Karantika lover","url":"https://github.com/fcmam5","socials":{"x":"https://x.com/fcmam5","github":"https://github.com/fcmam5"},"imageURL":"https://github.com/fcmam5.png","key":"fcmam5","page":null}],"frontMatter":{"description":"Learning about cybersecurity as a developer by playing CTF (Part1: Template engines and SSTI)","slug":"ctf-as-a-developer-pt-1-template-engines-ssti","authors":["fcmam5"],"tags":["backend","cybersecurity","frontend"]},"unlisted":false,"prevItem":{"title":"Avoiding NestJS performance bottlenecks","permalink":"/blog/avoiding-nestjs-performance-bottlenecks"},"nextItem":{"title":"Trying to become a better developer by learning more about\xa0aviation","permalink":"/blog/trying-to-become-a-better-developer-by-learning-more-about-aviation"}}')}}]);
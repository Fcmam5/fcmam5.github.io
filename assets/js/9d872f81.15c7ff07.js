"use strict";(self.webpackChunkportfolio=self.webpackChunkportfolio||[]).push([[9898],{7991:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>n,toc:()=>l});var n=t(1206),i=t(6070),r=t(989);const o={description:"Jest tips & tricks",slug:"jest-utility",showLastUpdateTime:!0,authors:["fcmam5"],tags:["js","ts","testing"]},c="Jest-uatlity: Making work with Jest fun\xa0again",a={authorsImageUrls:[void 0]},l=[{value:"Snippets",id:"snippets",level:2},{value:"Mock promise rejection",id:"mock-promise-rejection",level:3},{value:"Mocked methods chaining",id:"mocked-methods-chaining",level:3},{value:"IDE Setup",id:"ide-setup",level:2},{value:"VS Code",id:"vs-code",level:3},{value:"Tricks",id:"tricks",level:2},{value:"Using <code>it.each</code> and <code>describe.each</code>",id:"using-iteach-and-describeeach",level:3},{value:"Using <code>jest-when</code> to specify dynamic returns matched with specific arguments",id:"using-jest-when-to-specify-dynamic-returns-matched-with-specific-arguments",level:3},{value:"Using <code>jest-extended</code> to have more matchers",id:"using-jest-extended-to-have-more-matchers",level:3},{value:"Learnings",id:"learnings",level:2},{value:"Why does Jest run faster with --maxWorkers=50%?",id:"why-does-jest-run-faster-with---maxworkers50",level:3},{value:"Globals in Jest environment differ from NodeJS&#39;s",id:"globals-in-jest-environment-differ-from-nodejss",level:3},{value:"<code>jest.mock</code> calls are automatically hoisted",id:"jestmock-calls-are-automatically-hoisted",level:3},{value:"Jest mocks have to have <code>mock</code> in names",id:"jest-mocks-have-to-have-mock-in-names",level:3}];function d(e){const s={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.p,{children:"Jest is my go-to testing framework, it's the default in many of tools I use at work in my side projects and I didn't bother to reconfigure NestJS or NX.dev before I start a new project. Jest works for me, and works well."}),"\n",(0,i.jsx)(s.p,{children:"But sometimes... Sometimes... I have to Google a little bit harder before I figure out how to do things."}),"\n",(0,i.jsxs)(s.p,{children:["In this blog I will share some of the tricks I learned, and some of the concepts I didn't know which led me to a frustrating debugging sessions. For example, the fact that ",(0,i.jsx)(s.code,{children:"jest.mock"})," is hoisted, which makes using variables in mocked modules a bit tricky."]}),"\n",(0,i.jsx)(s.p,{children:"This blog will be updated each time I remember some of the tricks, or I learn something new about Jest."}),"\n",(0,i.jsx)(s.h2,{id:"snippets",children:"Snippets"}),"\n",(0,i.jsx)(s.h3,{id:"mock-promise-rejection",children:"Mock promise rejection"}),"\n",(0,i.jsx)(s.p,{children:"Source:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://jestjs.io/docs/tutorial-async#rejects",children:"https://jestjs.io/docs/tutorial-async#rejects"})}),"\n"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-js",children:"it('tests error with async/await and rejects', async () => {\n  expect.assertions(1);\n  await expect(user.getUserName(3)).rejects.toEqual({\n    error: 'User with 3 not found.',\n  });\n});\n"})}),"\n",(0,i.jsx)(s.h3,{id:"mocked-methods-chaining",children:"Mocked methods chaining"}),"\n",(0,i.jsx)(s.p,{children:"Example:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-js",children:"if (errors.length) return res.status(400).json(errors);\n"})}),"\n",(0,i.jsx)(s.p,{children:"Mock:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-js",children:"mockResponse = {\n  status: jest.fn().mockReturnThis(),\n  json: jest.fn(),\n};\n"})}),"\n",(0,i.jsxs)(s.p,{children:["Ref: ",(0,i.jsx)(s.a,{href:"https://stackoverflow.com/a/75811953/5078746",children:"https://stackoverflow.com/a/75811953/5078746"})]}),"\n",(0,i.jsx)(s.h2,{id:"ide-setup",children:"IDE Setup"}),"\n",(0,i.jsx)(s.h3,{id:"vs-code",children:"VS Code"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Jest Snippets: ",(0,i.jsx)(s.a,{href:"https://marketplace.visualstudio.com/items?itemName=andys8.jest-snippets",children:"andys8.jest-snippets"})]}),"\n",(0,i.jsxs)(s.li,{children:["Jest (by Orta): ",(0,i.jsx)(s.a,{href:"https://marketplace.visualstudio.com/items?itemName=Orta.vscode-jest",children:"Orta.vscode-jest"})]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"tricks",children:"Tricks"}),"\n",(0,i.jsxs)(s.h3,{id:"using-iteach-and-describeeach",children:["Using ",(0,i.jsx)(s.code,{children:"it.each"})," and ",(0,i.jsx)(s.code,{children:"describe.each"})]}),"\n",(0,i.jsx)(s.p,{children:"Example:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-js",children:'  it.each([\n    ["no args were passed", undefined, productInfoMissingErr],\n    ["no product IDs were passed", noIdData, productInfoMissingErr],\n    [\n      "an empty array of products was passed",\n      { products: [] },\n      productIdMissingErr,\n    ],\n  ])("should throw if %s", (caseTitle, input, errMsg) => {\n    return readPricing().catch((e: Error) => {\n      expect.assertions(3);\n      expect(<jest.Mock>fetch).not.toHaveBeenCalled();\n      expect(e).toBeInstanceOf(TypeError);\n      expect(e.message).toBe(errMsg);\n    });\n  });\n'})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Link to the example on SoF: ",(0,i.jsx)(s.a,{href:"https://stackoverflow.com/a/75527420/5078746",children:"https://stackoverflow.com/a/75527420/5078746"})]}),"\n",(0,i.jsxs)(s.li,{children:["Documentation:","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://jestjs.io/docs/api#testeachtablename-fn-timeout",children:(0,i.jsx)(s.code,{children:"it.each"})})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://jestjs.io/docs/api#describeeachtablename-fn-timeout",children:(0,i.jsx)(s.code,{children:"describe.each"})})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.admonition,{type:"tip",children:(0,i.jsxs)(s.p,{children:["If you are using ",(0,i.jsx)(s.a,{href:"https://marketplace.visualstudio.com/items?itemName=andys8.jest-snippets",children:"jest-snippets"})," in VS Code, just type ",(0,i.jsx)(s.code,{children:"ite"})," and ",(0,i.jsx)(s.code,{children:"desce"}),"."]})}),"\n",(0,i.jsxs)(s.h3,{id:"using-jest-when-to-specify-dynamic-returns-matched-with-specific-arguments",children:["Using ",(0,i.jsx)(s.code,{children:"jest-when"})," to specify dynamic returns matched with specific arguments"]}),"\n",(0,i.jsx)(s.p,{children:"Package:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://www.npmjs.com/package/jest-when",children:"npm"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://github.com/timkindberg/jest-when",children:"Repository"})}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"Installation"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"npm i jest-when && npm i -D @types/jest-when\n"})}),"\n",(0,i.jsx)(s.p,{children:"Example"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-js",children:"const fn = jest.fn()                   \nwhen(fn)\n  .calledWith(/* any matchers here */)\n  .mockReturnValue(/* some value */)\n"})}),"\n",(0,i.jsxs)(s.h3,{id:"using-jest-extended-to-have-more-matchers",children:["Using ",(0,i.jsx)(s.code,{children:"jest-extended"})," to have more matchers"]}),"\n",(0,i.jsx)(s.p,{children:"Package:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://www.npmjs.com/package/jest-extended",children:"npm"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://github.com/jest-community/jest-extended",children:"Repository"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://jest-extended.jestcommunity.dev/docs/matchers/",children:"Documentation"})}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"Installation"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"npm i -D jest-extended\n"})}),"\n",(0,i.jsxs)(s.p,{children:["Example with ",(0,i.jsxs)(s.a,{href:"https://jest-extended.jestcommunity.dev/docs/matchers/date/#tobeafterdate",children:[(0,i.jsx)(s.code,{children:".toBeAfter(date)"})," matcher"]}),":"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-js",children:"test('passes when input is after date', () => {\n  expect(new Date('01/01/2019')).toBeAfter(new Date('01/01/2018'));\n  expect('01/01/2018').not.toBeAfter(new Date('01/01/2019'));\n});\n"})}),"\n",(0,i.jsx)(s.h2,{id:"learnings",children:"Learnings"}),"\n",(0,i.jsx)(s.h3,{id:"why-does-jest-run-faster-with---maxworkers50",children:"Why does Jest run faster with --maxWorkers=50%?"}),"\n",(0,i.jsxs)(s.p,{children:["Ref: ",(0,i.jsx)(s.a,{href:"https://stackoverflow.com/a/75490452/5078746",children:"https://stackoverflow.com/a/75490452/5078746"})]}),"\n",(0,i.jsxs)(s.blockquote,{children:["\n",(0,i.jsx)(s.p,{children:"That cost of spawning and scheduling multiple jest-workers might be sometimes greater than the gains we may get with parallelization. By using multiple workers you are instantiating more objects that will load different files from the disk. That's why in small and atomic tests you don't see any (or just a small) performance gain by using --maxWorkers=50%|1."}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"globals-in-jest-environment-differ-from-nodejss",children:"Globals in Jest environment differ from NodeJS's"}),"\n",(0,i.jsx)(s.p,{children:"Example #1:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-js",children:'it("throws TypeError when url is invalid", () => {\n  expect(() => {\n    new URL(""); // This does not work\n    // throw new TypeError(); // This works\n  }).toThrow(TypeError);\n})\n'})}),"\n",(0,i.jsx)(s.p,{children:"Proposed solution: Throw custom errors"}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.strong,{children:"Answers on StackOverflow:"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://stackoverflow.com/a/75569401/5078746",children:"https://stackoverflow.com/a/75569401/5078746"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://stackoverflow.com/a/75524385/5078746",children:"https://stackoverflow.com/a/75524385/5078746"})}),"\n"]}),"\n",(0,i.jsxs)(s.h3,{id:"jestmock-calls-are-automatically-hoisted",children:[(0,i.jsx)(s.code,{children:"jest.mock"})," calls are automatically hoisted"]}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsx)(s.strong,{children:"Resources:"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://github.com/jestjs/jest/issues/2582#issuecomment-272287545",children:"https://github.com/jestjs/jest/issues/2582#issuecomment-272287545"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://github.com/kentcdodds/how-jest-mocking-works",children:"https://github.com/kentcdodds/how-jest-mocking-works"})}),"\n"]}),"\n",(0,i.jsxs)(s.h3,{id:"jest-mocks-have-to-have-mock-in-names",children:["Jest mocks have to have ",(0,i.jsx)(s.code,{children:"mock"})," in names"]}),"\n",(0,i.jsxs)(s.p,{children:["Mocks must have ",(0,i.jsx)(s.code,{children:"mock"})," prefix in the name, otherwise you will see the following error:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"    Note: This is a precaution to guard against uninitialized mock variables. If it is ensured that the mock is required lazily, variable names prefixed with `mock` (case insensitive) are permitted.\n"})}),"\n",(0,i.jsx)(s.p,{children:"For example here:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-js",children:'const fakeEmoji = jest.fn();\n\njest.mock("./emoji", () => ({\n  getEmoji: fakeEmoji,\n}));\n\nconst { getHello } = require("./hello");\n\ndescribe("Testing my-module", () => {\n  beforeEach(() => {\n    fakeEmoji.mockReturnValue("\ud83d\ude0f");\n  });\n\n  it(\'should say "Hello {NAME}" with a smirk\', () => {\n    expect(getHello("Kadour")).toBe("Hello Kadour \ud83d\ude0f");\n  });\n});\n'})}),"\n",(0,i.jsxs)(s.p,{children:["My mock function (",(0,i.jsx)(s.code,{children:"fakeEmoji"}),") must have ",(0,i.jsx)(s.code,{children:"mock"})," prefix."]})]})}function h(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},989:(e,s,t)=>{t.d(s,{R:()=>o,x:()=>c});var n=t(758);const i={},r=n.createContext(i);function o(e){const s=n.useContext(r);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),n.createElement(r.Provider,{value:s},e.children)}},1206:e=>{e.exports=JSON.parse('{"permalink":"/snippets/jest-utility","source":"@site/snippets-blog/2024-05-06-jestuality/index.md","title":"Jest-uatlity: Making work with Jest fun\xa0again","description":"Jest tips & tricks","date":"2024-05-06T00:00:00.000Z","tags":[{"inline":true,"label":"js","permalink":"/snippets/tags/js"},{"inline":true,"label":"ts","permalink":"/snippets/tags/ts"},{"inline":true,"label":"testing","permalink":"/snippets/tags/testing"}],"readingTime":3.1,"hasTruncateMarker":true,"authors":[{"name":"Abdeldjalil Fortas","title":"A part-time Karantika lover","url":"https://github.com/fcmam5","socials":{"x":"https://x.com/fcmam5","github":"https://github.com/fcmam5"},"imageURL":"https://github.com/fcmam5.png","key":"fcmam5","page":null}],"frontMatter":{"description":"Jest tips & tricks","slug":"jest-utility","showLastUpdateTime":true,"authors":["fcmam5"],"tags":["js","ts","testing"]},"unlisted":false,"prevItem":{"title":"My npm notebook","permalink":"/snippets/npm-stuff"}}')}}]);